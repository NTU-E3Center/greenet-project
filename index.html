<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¶ é›»è½‰ä¾›æœ€ä½³åŒ–å¹³å°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
  <style>
    :root {
      --primary: #0F172A;
      --primary-fg: #F8FAFC;
      --bg: #FFFFFF;
      --surface: #FFFFFF;
      --muted: #F1F5F9;
      --muted-fg: #334155;
      --border: #E2E8F0;
      --border-strong: #CBD5E1;
      --success: #10B981;
      --success-bg: #D1FAE5;
      --success-dark: #065F46;
      --warning: #F59E0B;
      --warning-bg: #FEF3C7;
      --error: #EF4444;
      --error-bg: #FEE2E2;
      --accent: #6366F1;
      --accent-bg: #EEF2FF;
      --accent-dark: #4338CA;
      --text: #0F172A;
      --text-muted: #334155;
      --text-tertiary: #94A3B8;
      --radius: 0.5rem;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      border-right: 1px solid var(--border);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      background: var(--surface);
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .brand svg {
      flex-shrink: 0;
    }

    .brand h2 {
      font-size: 1rem;
      font-weight: 600;
    }

    .brand-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      padding-left: 2.25rem;
      margin-bottom: 1rem;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 1rem 0;
    }

    .nav-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 0.75rem;
    }

    .nav-step {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 150ms;
      margin-bottom: 0.25rem;
      text-decoration: none;
      color: inherit;
    }

    .nav-step:hover {
      border-color: var(--border-strong);
      box-shadow: var(--shadow-sm);
    }

    .nav-step.active {
      border-color: var(--accent);
      background: var(--accent-bg);
    }

    .nav-step.done {
      border-color: var(--success);
      background: #F0FDF4;
    }

    .nav-step .circle {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
      color: white;
      flex-shrink: 0;
    }

    .nav-step .circle.pending {
      background: #CBD5E1;
    }

    .nav-step .circle.active {
      background: var(--accent);
    }

    .nav-step .circle.done {
      background: var(--success);
    }

    .nav-step .step-title {
      font-size: 0.875rem;
      font-weight: 600;
    }

    .nav-step .step-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .nav-step .step-status {
      font-size: 0.6875rem;
      color: var(--text-muted);
      font-weight: 500;
      padding: 0.125rem 0.5rem;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 0.25rem;
      margin-left: auto;
    }

    .nav-arrow {
      text-align: center;
      color: #CBD5E1;
      margin: -0.125rem 0;
      font-size: 0.875rem;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      font-size: 0.6875rem;
      color: var(--text-tertiary);
    }

    /* Main */
    .main {
      margin-left: 260px;
      flex: 1;
      max-width: 1140px;
      padding: 2rem 2.5rem;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      transition: border-color 150ms, box-shadow 150ms;
    }

    .card:hover {
      box-shadow: var(--shadow);
      border-color: var(--border-strong);
    }

    .card-accent {
      border-left: 3px solid var(--primary);
    }

    /* Step Cards on homepage */
    .step-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin: 1.5rem 0;
    }

    .step-card {
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      text-align: center;
      min-height: 10rem;
      cursor: pointer;
      transition: all 200ms;
      box-shadow: var(--shadow-sm);
    }

    .step-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .step-card.highlight {
      border-color: var(--accent);
      background: var(--accent-bg);
    }

    .step-card .sc-circle {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #CBD5E1;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.5rem;
      font-weight: 600;
    }

    .step-card.highlight .sc-circle {
      background: var(--accent);
    }

    .step-card h3 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .step-card .sc-sub {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .step-card .sc-detail {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    /* Hero */
    .hero {
      text-align: center;
      padding: 1rem 0 0.5rem;
    }

    .hero h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .hero p {
      font-size: 0.9375rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto;
    }

    /* Section */
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      text-align: center;
      margin: 1.5rem 0 0.25rem;
    }

    .section-sub {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }

    /* Page content */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Page header */
    .page-header {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.015em;
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      font-size: 0.9375rem;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
      max-width: 65ch;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.5rem;
    }

    .form-select,
    .form-input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-family: inherit;
      background: var(--bg);
      outline: none;
      transition: border-color 150ms;
    }

    .form-select:focus,
    .form-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 150ms;
      border: 1px solid var(--border);
      min-height: 40px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--primary-fg);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background: #1E293B;
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
    }

    .btn-outline:hover {
      background: var(--muted);
    }

    .btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .btn-block {
      width: 100%;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }

    th {
      text-align: left;
      padding: 0.625rem 0.75rem;
      background: var(--muted);
      color: var(--text);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 0.625rem 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    tr:hover td {
      background: #FAFBFC;
    }

    /* Metric cards */
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .metric {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--primary);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
    }

    .metric .m-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.25rem;
    }

    .metric .m-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .metric .m-sub {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-top: 0.25rem;
    }

    .metric.green {
      border-left-color: var(--success);
    }

    .metric.red {
      border-left-color: var(--error);
    }

    .metric.purple {
      border-left-color: #8B5CF6;
    }

    /* Banner */
    .banner {
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      margin: 1rem 0;
      background: #F8FAFC;
      border: 1px solid var(--border);
      border-left: 3px solid var(--primary);
    }

    .banner.green {
      border-left-color: var(--success);
    }

    .banner.purple {
      border-left-color: #8B5CF6;
    }

    .banner h4 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .banner p {
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    /* Progress */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--muted);
      border-radius: 4px;
      overflow: hidden;
      margin: 0.75rem 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Stepper */
    .stepper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 1.5rem 0;
    }

    .stepper .st-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      font-size: 0.8125rem;
      font-weight: 500;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 150ms;
    }

    .stepper .st-item.active {
      background: var(--accent-bg);
      border-color: var(--accent);
      color: var(--accent-dark);
    }

    .stepper .st-item.done {
      background: #F0FDF4;
      border-color: var(--success);
      color: var(--success-dark);
    }

    .stepper .st-arrow {
      color: var(--text-tertiary);
      font-size: 0.75rem;
    }

    /* Checkbox list */
    .check-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .check-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 150ms;
    }

    .check-item:hover {
      background: var(--muted);
    }

    .check-item.checked {
      background: var(--accent-bg);
      border-color: var(--accent);
    }

    .check-item input[type=checkbox] {
      accent-color: var(--accent);
    }

    /* Compare */
    .compare {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin: 1rem 0;
    }

    .compare .card h4 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    /* Chart container */
    .chart-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin: 1rem 0;
    }

    .chart-wrap h4 {
      font-size: 0.9375rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    canvas {
      max-height: 300px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      transition: all 150ms;
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab:hover {
      color: var(--primary);
    }

    /* Settlement flow */
    .flow-steps {
      display: flex;
      align-items: stretch;
      gap: 1rem;
      margin: 1rem 0;
    }

    .flow-step {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      text-align: center;
    }

    .flow-step h5 {
      font-size: 0.8125rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
    }

    .flow-step p {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .flow-step .arrow {
      font-size: 1.25rem;
      color: var(--text-tertiary);
    }

    /* Type selection cards */
    .type-card {
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 0.75rem 0.75rem;
      text-align: center;
      cursor: pointer;
      transition: all 200ms;
      background: var(--surface);
    }

    .type-card:hover {
      border-color: #CBD5E1;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .type-card.selected {
      border-color: var(--primary);
      background: #F8FAFF;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .type-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .type-curve {
      width: 100%;
      height: 48px;
      margin-bottom: 0.5rem;
    }

    .type-radio {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .radio-dot {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #CBD5E1;
      transition: all 150ms;
    }

    .type-card.selected .radio-dot {
      border-color: var(--primary);
      background: var(--primary);
      box-shadow: inset 0 0 0 3px #fff;
    }

    .type-card.selected .radio-text {
      color: var(--primary);
      font-weight: 600;
    }

    .source-tag {
      display: inline-block;
      font-size: 0.6875rem;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-weight: 500;
      white-space: nowrap;
    }

    .source-tag.db {
      background: #ECFDF5;
      color: #065F46;
      border: 1px solid #A7F3D0;
    }

    .source-tag.manual {
      background: #FFFBEB;
      color: #92400E;
      border: 1px solid #FDE68A;
    }

    /* Responsive */
    @media (max-width:900px) {
      .sidebar {
        display: none;
      }

      .main {
        margin-left: 0;
        padding: 1rem;
      }

      .step-cards {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .compare {
        grid-template-columns: 1fr;
      }

      .check-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand" onclick="showPage('home')" style="cursor:pointer;">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#0F172A" stroke-width="2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
      </svg>
      <h2>ç¶ èƒ½è½‰ä¾›å¹³å°</h2>
    </div>
    <p class="brand-sub">æ™ºæ…§åª’åˆèˆ‡æœ€ä½³åŒ–</p>
    <div class="divider"></div>
    <p class="nav-label">æˆç†Ÿåº¦éšæ¢¯</p>
    <div class="nav-step" id="nav-m1" onclick="showPage('m1')">
      <div style="flex:1">
        <div class="step-title">M1ï¼šç”¨é›»æ•¸æ“šæ¨¡æ“¬</div>
        <div class="step-desc">æ¨¡æ“¬ç”¨é›»æ›²ç·š</div>
      </div>
    </div>

    <div class="nav-step" id="nav-m2" onclick="showPage('m2')">
      <div style="flex:1">
        <div class="step-title">M2ï¼šè½‰ä¾›çµç®—</div>
        <div class="step-desc">ä¾å°é›»è¦å‰‡è¨ˆç®—</div>
      </div>
    </div>

    <div class="nav-step" id="nav-m3" onclick="showPage('m3')">
      <div style="flex:1">
        <div class="step-title">M3ï¼šè½‰ä¾›æœ€ä½³åŒ–</div>
        <div class="step-desc">AI è¼”åŠ©æ±ºç­–</div>
      </div>
    </div>

    <p class="sidebar-footer">v1.0.0 Â· PRD Demo</p>
  </aside>

  <!-- Main Content -->
  <main class="main">

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="hero">
        <h1>ç¶ é›»è½‰ä¾›æœ€ä½³åŒ–å¹³å°</h1>
      </div>
      <div
        style="text-align:center;padding:1.5rem 1rem;margin:1rem 0;background:linear-gradient(135deg,#EEF2FF 0%,#ECFDF5 100%);border-radius:0.75rem;border:1px solid #E2E8F0;">
        <div style="font-size:2rem;margin-bottom:0.5rem;">âš¡</div>
        <h2 style="font-size:1.125rem;font-weight:600;margin-bottom:0.25rem;">é–‹å§‹æ‚¨çš„ç¶ é›»è½‰ä¾›åˆ†æ</h2>
        <p style="color:var(--text-muted);font-size:0.875rem;max-width:500px;margin:0 auto;">
          é¸æ“‡ç”¨æˆ¶é¡å‹ï¼Œè¼¸å…¥é›»è²»å–®è³‡è¨Šï¼Œç³»çµ±å°‡ç”Ÿæˆæ¨¡æ“¬æ•¸æ“šä¸¦å”åŠ©æ‚¨é€²è¡Œè½‰ä¾›çµç®—èˆ‡æœ€ä½³åŒ–</p>
      </div>
      <div class="step-cards">
        <div class="step-card highlight" onclick="showPage('m1')">
          <div class="sc-circle" style="background:var(--accent);">1</div>
          <h3>ç”¨é›»æ•¸æ“šæ¨¡æ“¬</h3>
          <p class="sc-detail">é¸æ“‡å®¢æˆ¶é¡å‹ / è¼¸å…¥é›»è²»å–® / ç”Ÿæˆæ¨¡æ“¬æ•¸æ“š</p>
        </div>
        <div class="step-card" onclick="showPage('m2')">
          <div class="sc-circle">2</div>
          <h3>è½‰ä¾›çµç®—</h3>
          <p class="sc-detail">å°é›»è¦ç«  / å…©éšæ®µé…å° / çµç®—åˆ†æ</p>
        </div>
        <div class="step-card" onclick="showPage('m3')">
          <div class="sc-circle">3</div>
          <h3>è½‰ä¾›æœ€ä½³åŒ–</h3>
          <p class="sc-detail">é¸æ“‡ç¯„åœ / è¨­å®šç´„æŸ / æœ€ä½³åŒ–çµæœ</p>
        </div>
      </div>
    </div>

    <!-- MODULE 1 -->
    <div class="page" id="page-m1">
      <h1 class="page-header">ğŸ“Š æ¨¡çµ„ä¸€ï¼šç”¨é›»æ•¸æ“šæ¨¡æ“¬</h1>
      <p class="page-subtitle">ç‚ºç¼ºä¹ 15 åˆ†é˜ç²¾åº¦æ­·å²ç”¨é›»æ•¸æ“šçš„å®¢æˆ¶ï¼Œæ ¹æ“šç”¨æˆ¶ç‰¹æ€§æ¨¡æ“¬ç”¨é›»æ›²ç·šã€‚</p>

      <!-- Step 1: è¼¸å…¥ç”¨é›»æ•¸æ“š -->
      <div class="card" style="margin-bottom:1.5rem;" id="m1-step1">
        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
          <div class="circle active" style="width:2rem;height:2rem;font-size:0.8rem;">1</div>
          <div style="flex:1;">
            <h3 style="font-size:1rem;font-weight:600;margin:0;">Step 1ï¼šè¼¸å…¥ç”¨é›»æ•¸æ“š</h3>
            <p style="font-size:0.8125rem;color:var(--text-muted);margin:0;">è«‹å¡«å…¥éå» 12 å€‹æœˆçš„å°–å³°ã€åŠå°–å³°ã€é›¢å³°é›»è²»é‡‘é¡ï¼ˆå…ƒï¼‰</p>
          </div>
          <button class="btn btn-outline" style="font-size:0.75rem;padding:0.375rem 0.75rem;white-space:nowrap;"
            onclick="fillM1Example()">ğŸ“ å¡«å…¥ç¯„ä¾‹</button>
        </div>
        <div style="overflow-x:auto;">
          <table class="m1-input-table" style="width:100%;border-collapse:collapse;font-size:0.8125rem;">
            <thead>
              <tr>
                <th
                  style="text-align:left;padding:0.5rem 0.75rem;background:var(--muted);font-size:0.75rem;border-bottom:1px solid var(--border);min-width:150px;">
                  æœˆä»½</th>
                <th
                  style="text-align:center;padding:0.5rem 0.75rem;background:#FEF2F2;color:#991B1B;font-size:0.75rem;border-bottom:1px solid var(--border);min-width:120px;">
                  ğŸ”´ å°–å³°ï¼ˆå…ƒï¼‰</th>
                <th
                  style="text-align:center;padding:0.5rem 0.75rem;background:#FFF7ED;color:#9A3412;font-size:0.75rem;border-bottom:1px solid var(--border);min-width:120px;">
                  ğŸŸ  åŠå°–å³°ï¼ˆå…ƒï¼‰</th>
                <th
                  style="text-align:center;padding:0.5rem 0.75rem;background:#F0FDF4;color:#166534;font-size:0.75rem;border-bottom:1px solid var(--border);min-width:120px;">
                  ğŸŸ¢ é›¢å³°ï¼ˆå…ƒï¼‰</th>
                <th
                  style="text-align:center;padding:0.5rem 0.75rem;background:var(--muted);font-size:0.75rem;border-bottom:1px solid var(--border);min-width:100px;">
                  å°è¨ˆ</th>
              </tr>
            </thead>
            <tbody id="m1-input-tbody">
            </tbody>
            <tfoot>
              <tr style="background:var(--muted);font-weight:600;">
                <td style="padding:0.625rem 0.75rem;border-top:2px solid var(--border-strong);">åˆè¨ˆ</td>
                <td
                  style="padding:0.625rem 0.75rem;border-top:2px solid var(--border-strong);text-align:center;color:#991B1B;"
                  id="m1-total-peak">0</td>
                <td
                  style="padding:0.625rem 0.75rem;border-top:2px solid var(--border-strong);text-align:center;color:#9A3412;"
                  id="m1-total-mid">0</td>
                <td
                  style="padding:0.625rem 0.75rem;border-top:2px solid var(--border-strong);text-align:center;color:#166534;"
                  id="m1-total-off">0</td>
                <td
                  style="padding:0.625rem 0.75rem;border-top:2px solid var(--border-strong);text-align:center;font-weight:700;"
                  id="m1-total-all">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Step 2: User Type Selection -->
      <div class="card" style="margin-bottom:1.5rem;" id="m1-step2">
        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;">
          <div class="circle active" style="width:2rem;height:2rem;font-size:0.8rem;">2</div>
          <div>
            <h3 style="font-size:1rem;font-weight:600;margin:0;">Step 2ï¼šé¸æ“‡ç”¨æˆ¶é¡å‹</h3>
            <p style="font-size:0.8125rem;color:var(--text-muted);margin:0;">è«‹é¸æ“‡æœ€æ¥è¿‘çš„ç”¨é›»å‹æ…‹ï¼Œç³»çµ±å°‡çµåˆæ‚¨å¡«å…¥çš„é›»è²»æ•¸æ“šç”Ÿæˆæ¨¡æ“¬æ›²ç·š</p>
          </div>
        </div>
        <label class="form-label">é¸æ“‡æœ€æ¥è¿‘æ‚¨çš„ç”¨é›»å‹æ…‹</label>
        <input type="hidden" id="userType" value="24h">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.25rem;"
          id="m1-type-cards">
          <!-- 24å°æ™‚ç‡Ÿé‹ -->
          <div class="type-card selected" data-type="24h" onclick="selectUserType(this,'24h')">
            <div style="font-size:1.75rem;margin-bottom:0.25rem;">ğŸ­</div>
            <div class="type-label">24å°æ™‚ç‡Ÿé‹</div>
            <svg viewBox="0 0 120 40" class="type-curve">
              <defs>
                <linearGradient id="fill24h" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="#94A3B8" stop-opacity="0.3" />
                  <stop offset="100%" stop-color="#94A3B8" stop-opacity="0.05" />
                </linearGradient>
              </defs>
              <path d="M0,12 L10,11 20,13 30,12 40,11 50,12 60,13 70,12 80,11 90,12 100,13 110,12 120,11" fill="none"
                stroke="#64748B" stroke-width="1.5" />
              <path d="M0,12 L10,11 20,13 30,12 40,11 50,12 60,13 70,12 80,11 90,12 100,13 110,12 120,11 L120,40 0,40Z"
                fill="url(#fill24h)" />
            </svg>
            <div class="type-radio"><span class="radio-dot"></span> <span class="radio-text">å·²é¸æ“‡</span></div>
          </div>
          <!-- è¾¦å…¬å®¤ -->
          <div class="type-card" data-type="office" onclick="selectUserType(this,'office')">
            <div style="font-size:1.75rem;margin-bottom:0.25rem;">ğŸ’¼</div>
            <div class="type-label">è¾¦å…¬å®¤</div>
            <svg viewBox="0 0 120 40" class="type-curve">
              <defs>
                <linearGradient id="fillOffice" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="#94A3B8" stop-opacity="0.3" />
                  <stop offset="100%" stop-color="#94A3B8" stop-opacity="0.05" />
                </linearGradient>
              </defs>
              <path d="M0,35 L15,34 25,30 35,15 45,8 55,7 65,7 75,8 85,15 95,30 105,34 120,35" fill="none"
                stroke="#64748B" stroke-width="1.5" />
              <path d="M0,35 L15,34 25,30 35,15 45,8 55,7 65,7 75,8 85,15 95,30 105,34 120,35 L120,40 0,40Z"
                fill="url(#fillOffice)" />
            </svg>
            <div class="type-radio"><span class="radio-dot"></span> <span class="radio-text">é¸æ“‡</span></div>
          </div>
          <!-- é–€å¸‚ -->
          <div class="type-card" data-type="store" onclick="selectUserType(this,'store')">
            <div style="font-size:1.75rem;margin-bottom:0.25rem;">ğŸª</div>
            <div class="type-label">é–€å¸‚</div>
            <svg viewBox="0 0 120 40" class="type-curve">
              <defs>
                <linearGradient id="fillStore" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="#F59E0B" stop-opacity="0.3" />
                  <stop offset="100%" stop-color="#F59E0B" stop-opacity="0.05" />
                </linearGradient>
              </defs>
              <path d="M0,30 L10,28 20,22 30,12 40,7 50,5 60,5 70,5 80,7 90,12 100,22 110,28 120,30" fill="none"
                stroke="#F59E0B" stroke-width="1.5" />
              <path d="M0,30 L10,28 20,22 30,12 40,7 50,5 60,5 70,5 80,7 90,12 100,22 110,28 120,30 L120,40 0,40Z"
                fill="url(#fillStore)" />
            </svg>
            <div class="type-radio"><span class="radio-dot"></span> <span class="radio-text">é¸æ“‡</span></div>
          </div>
          <!-- ç™¾è²¨ -->
          <div class="type-card" data-type="mall" onclick="selectUserType(this,'mall')">
            <div style="font-size:1.75rem;margin-bottom:0.25rem;">ğŸ¬</div>
            <div class="type-label">ç™¾è²¨</div>
            <svg viewBox="0 0 120 40" class="type-curve">
              <defs>
                <linearGradient id="fillMall" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="#8B5CF6" stop-opacity="0.3" />
                  <stop offset="100%" stop-color="#8B5CF6" stop-opacity="0.05" />
                </linearGradient>
              </defs>
              <path d="M0,35 L20,34 35,32 50,28 60,20 70,12 80,8 90,7 100,8 110,12 120,18" fill="none" stroke="#8B5CF6"
                stroke-width="1.5" />
              <path d="M0,35 L20,34 35,32 50,28 60,20 70,12 80,8 90,7 100,8 110,12 120,18 L120,40 0,40Z"
                fill="url(#fillMall)" />
            </svg>
            <div class="type-radio"><span class="radio-dot"></span> <span class="radio-text">é¸æ“‡</span></div>
          </div>
        </div>

        <button class="btn btn-primary btn-block" onclick="runSimulation()">âš¡ ç”Ÿæˆæ¨¡æ“¬æ•¸æ“š</button>
      </div>

      <!-- Results -->
      <div id="sim-result" style="display:none;">
        <div class="metrics">
          <div class="metric">
            <div class="m-label">ç¸½æ¨¡æ“¬æ•¸æ“š</div>
            <div class="m-value">35,040</div>
            <div class="m-sub">ç­† (15åˆ†é˜ Ã— 12å€‹æœˆ)</div>
          </div>
          <div class="metric green">
            <div class="m-label">æœˆå¹³å‡ç”¨é›»</div>
            <div class="m-value" id="avgKwh">35,000</div>
            <div class="m-sub">kWh/æœˆ</div>
          </div>
          <div class="metric purple">
            <div class="m-label">å°–å³°ä½”æ¯”</div>
            <div class="m-value" id="peakRatio">43%</div>
            <div class="m-sub">of total</div>
          </div>
        </div>
        <div class="chart-wrap">
          <div
            style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem;flex-wrap:wrap;gap:0.5rem;">
            <h4 style="margin:0;">15 åˆ†é˜è² è¼‰æ›²ç·šï¼ˆå…¨å¹´ 35,040 ç­†ï¼‰</h4>
            <div style="display:flex;gap:0.375rem;" id="m1-zoom-controls">
              <button class="btn btn-outline" style="padding:0.25rem 0.625rem;font-size:0.75rem;"
                onclick="zoomLoadChart('1d')">1 æ—¥</button>
              <button class="btn btn-outline" style="padding:0.25rem 0.625rem;font-size:0.75rem;"
                onclick="zoomLoadChart('1w')">1 é€±</button>
              <button class="btn btn-outline" style="padding:0.25rem 0.625rem;font-size:0.75rem;"
                onclick="zoomLoadChart('1m')">1 æœˆ</button>
              <button class="btn btn-outline" style="padding:0.25rem 0.625rem;font-size:0.75rem;"
                onclick="zoomLoadChart('all')">å…¨å¹´</button>
              <button class="btn btn-outline" style="padding:0.25rem 0.625rem;font-size:0.75rem;"
                onclick="resetLoadChartZoom()">ğŸ”„ é‡ç½®</button>
            </div>
          </div>
          <p style="font-size:0.75rem;color:var(--text-tertiary);margin:0 0 0.5rem;">ğŸ’¡ å¯æ»¾è¼ªç¸®æ”¾ Â· æ‹–æ›³å¹³ç§» Â· æˆ–ä½¿ç”¨ä¸Šæ–¹æŒ‰éˆ•å¿«é€Ÿåˆ‡æ›æª¢è¦–ç¯„åœ
          </p>
          <canvas id="chartLoad" style="height:320px;"></canvas>
        </div>
        <div style="display:flex;gap:0.75rem;">
          <button class="btn btn-outline" style="flex:1;" onclick="exportTimeSeries()">ğŸ“¥ åŒ¯å‡ºæ™‚åºè³‡æ–™ï¼ˆå­˜å…¥è³‡æ–™åº«ï¼‰</button>
        </div>
      </div>
    </div>

    <!-- MODULE 2 -->
    <div class="page" id="page-m2">
      <h1 class="page-header">âš–ï¸ æ¨¡çµ„äºŒï¼šè½‰ä¾›çµç®—å¼•æ“</h1>
      <p class="page-subtitle">ä¾æ“šå°é›»ã€Šé›»èƒ½è½‰ä¾›èˆ‡ä½µç¶²å‹ç›´ä¾›ç‡Ÿé‹è¦ç« ã€‹ç¬¬ 13 æ¢ï¼Œå»ºç«‹å…©éšæ®µåª’åˆè¨ˆç®—å¼•æ“ã€‚</p>

      <div class="stepper" id="m2-stepper">
        <div class="st-item active" id="m2s1" onclick="showM2Step(1)">â‘  é¸æ“‡å…¬å¸</div>
        <span class="st-arrow">â†’</span>
        <div class="st-item" id="m2s2" onclick="showM2Step(2)">â‘¡ æ™‚é–“ç¯„åœ</div>
        <span class="st-arrow">â†’</span>
        <div class="st-item" id="m2s3" onclick="showM2Step(3)">â‘¢ å¥‘ç´„è¨­å®š</div>
        <span class="st-arrow">â†’</span>
        <div class="st-item" id="m2s4" onclick="showM2Step(4)">â‘£ ç¢ºèªè¼¸å…¥</div>
        <span class="st-arrow">â†’</span>
        <div class="st-item" id="m2s5" onclick="showM2Step(5)">â‘¤ çµç®—çµæœ</div>
      </div>

      <div class="m2-step" id="m2-step-1">
        <div class="banner">
          <h4>Step 1ï¼šé¸æ“‡åƒèˆ‡çµç®—çš„å…¬å¸</h4>
          <p>å‹¾é¸æœ¬æ¬¡è¦é€²è¡Œè½‰ä¾›çµç®—çš„ç™¼é›»ç«¯ä¼æ¥­èˆ‡ç”¨é›»ç«¯ä¼æ¥­ã€‚è‹¥ä¼æ¥­ä¸åœ¨è³‡æ–™åº«ä¸­ï¼Œå¯æ‰‹å‹•æ–°å¢ä¸¦ä¸Šå‚³æ•¸æ“šã€‚</p>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
          <!-- Generator Side -->
          <div>
            <label class="form-label" style="margin-bottom:0.75rem;">ğŸ”‹ ç™¼é›»ç«¯ä¼æ¥­</label>
            <div class="check-list" style="grid-template-columns:1fr;" id="m2-gen-list">
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> â˜€ï¸ GEN-001
                å¤©èƒ½å¤ªé™½èƒ½ä¸€å»  500kWï¼ˆæ”¶è³¼åƒ¹ 4.20ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> â˜€ï¸ GEN-002
                å¤©èƒ½å¤ªé™½èƒ½äºŒå»  300kWï¼ˆæ”¶è³¼åƒ¹ 4.50ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> â˜€ï¸ GEN-003
                å¤©èƒ½å¤ªé™½èƒ½ä¸‰å»  800kWï¼ˆæ”¶è³¼åƒ¹ 3.80ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item"><input type="checkbox" onchange="toggleCheck(this)"> â˜€ï¸ GEN-004 å¤©èƒ½å¤ªé™½èƒ½å››å» 
                200kWï¼ˆæ”¶è³¼åƒ¹ 4.80ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
            </div>
            <button class="btn btn-outline" style="margin-top:0.75rem;width:100%;font-size:0.8125rem;"
              onclick="toggleM2AddForm('gen')">â• æ‰‹å‹•æ–°å¢ç™¼é›»ç«¯ä¼æ¥­</button>
            <div id="m2-add-gen-form"
              style="display:none;margin-top:0.75rem;padding:1rem;background:#FEFCE8;border:1px solid #FDE68A;border-radius:var(--radius);">
              <h5 style="font-size:0.8125rem;font-weight:600;margin:0 0 0.75rem;color:#92400E;">ğŸ“ æ–°å¢ç™¼é›»ç«¯ä¼æ¥­</h5>
              <div style="display:grid;gap:0.5rem;">
                <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">ä¼æ¥­åç¨±</label><input
                    class="form-input" type="text" placeholder="ä¾‹ï¼šXXå¤ªé™½èƒ½é›»å» " id="m2-new-gen-name"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">é¡å‹</label>
                    <select class="form-input" id="m2-new-gen-type">
                      <option value="â˜€ï¸ å¤ªé™½èƒ½">â˜€ï¸ å¤ªé™½èƒ½</option>
                      <option value="ğŸŒŠ é¢¨åŠ›">ğŸŒŠ é¢¨åŠ›</option>
                      <option value="ğŸ’§ æ°´åŠ›">ğŸ’§ æ°´åŠ›</option>
                    </select>
                  </div>
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">å®¹é‡
                      (kW)</label><input class="form-input" type="number" placeholder="500" id="m2-new-gen-cap"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">æ”¶è³¼åƒ¹
                      (å…ƒ/åº¦)</label><input class="form-input" type="number" step="0.01" placeholder="4.20"
                      id="m2-new-gen-price"></div>
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">è½‰ä¾›æ¯”ä¾‹
                      (%)</label><input class="form-input" type="number" value="100" min="0" max="100"
                      id="m2-new-gen-ratio"></div>
                </div>
                <div class="form-group">
                  <label style="font-size:0.75rem;color:var(--text-muted);">ä¸Šå‚³ç™¼é›»æ™‚åºè³‡æ–™ (15åˆ†é˜, CSV)</label>
                  <div
                    style="border:1.5px dashed var(--border);border-radius:var(--radius);padding:0.75rem;text-align:center;cursor:pointer;background:#FFFBEB;"
                    onclick="this.querySelector('input').click()">
                    <span style="font-size:0.8125rem;color:var(--text-muted);">ğŸ“„ é»æ“Šä¸Šå‚³ .csv / .xlsx</span>
                    <input type="file" accept=".csv,.xlsx" style="display:none;"
                      onchange="this.parentElement.innerHTML='<span style=\'font-size:0.8125rem;color:#065F46;\'>âœ… '+this.files[0].name+'</span>'">
                  </div>
                </div>
                <button class="btn btn-primary" style="font-size:0.8125rem;" onclick="addManualCompany('gen')">âœ“
                  åŠ å…¥åˆ—è¡¨</button>
              </div>
            </div>
          </div>
          <!-- Consumer Side -->
          <div>
            <label class="form-label" style="margin-bottom:0.75rem;">ğŸ¢ ç”¨é›»ç«¯ä¼æ¥­</label>
            <div class="check-list" style="grid-template-columns:1fr;" id="m2-usr-list">
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ­ USR-001
                å°ç©é›»ç«¹ç§‘å» ï¼ˆå”®é›»åƒ¹ 5.00ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ¢ USR-002
                è¯è¯é›»å­ç¸½éƒ¨ï¼ˆå”®é›»åƒ¹ 5.20ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸª USR-003
                å…¨å®¶ä¾¿åˆ©å•†åº—Aå€ï¼ˆå”®é›»åƒ¹ 5.50ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ¬ USR-004
                é æ±ç™¾è²¨æ¿æ©‹åº—ï¼ˆå”®é›»åƒ¹ 5.30ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
            </div>
            <button class="btn btn-outline" style="margin-top:0.75rem;width:100%;font-size:0.8125rem;"
              onclick="toggleM2AddForm('usr')">â• æ‰‹å‹•æ–°å¢ç”¨é›»ç«¯ä¼æ¥­</button>
            <div id="m2-add-usr-form"
              style="display:none;margin-top:0.75rem;padding:1rem;background:#EFF6FF;border:1px solid #BFDBFE;border-radius:var(--radius);">
              <h5 style="font-size:0.8125rem;font-weight:600;margin:0 0 0.75rem;color:#1E40AF;">ğŸ“ æ–°å¢ç”¨é›»ç«¯ä¼æ¥­</h5>
              <div style="display:grid;gap:0.5rem;">
                <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">ä¼æ¥­åç¨±</label><input
                    class="form-input" type="text" placeholder="ä¾‹ï¼šXXç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸" id="m2-new-usr-name"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;">
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">å”®é›»åƒ¹
                      (å…ƒ/åº¦)</label><input class="form-input" type="number" step="0.01" placeholder="5.00"
                      id="m2-new-usr-price"></div>
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">æœˆä¸Šé™
                      (kWh)</label><input class="form-input" type="number" placeholder="50000" id="m2-new-usr-mlimit">
                  </div>
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">å¹´ä¸Šé™
                      (kWh)</label><input class="form-input" type="number" placeholder="500000" id="m2-new-usr-ylimit">
                  </div>
                </div>
                <div class="form-group">
                  <label style="font-size:0.75rem;color:var(--text-muted);">ä¸Šå‚³ç”¨é›»æ™‚åºè³‡æ–™ (15åˆ†é˜, CSV)</label>
                  <div
                    style="border:1.5px dashed var(--border);border-radius:var(--radius);padding:0.75rem;text-align:center;cursor:pointer;background:#EFF6FF;"
                    onclick="this.querySelector('input').click()">
                    <span style="font-size:0.8125rem;color:var(--text-muted);">ğŸ“„ é»æ“Šä¸Šå‚³ .csv / .xlsx</span>
                    <input type="file" accept=".csv,.xlsx" style="display:none;"
                      onchange="this.parentElement.innerHTML='<span style=\'font-size:0.8125rem;color:#065F46;\'>âœ… '+this.files[0].name+'</span>'">
                  </div>
                </div>
                <button class="btn btn-primary" style="font-size:0.8125rem;" onclick="addManualCompany('usr')">âœ“
                  åŠ å…¥åˆ—è¡¨</button>
              </div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:1rem;" onclick="showM2Step(2)">ä¸‹ä¸€æ­¥ â†’</button>
      </div>

      <!-- M2 Step 2: Time Range -->
      <div class="m2-step" id="m2-step-2" style="display:none;">
        <div class="banner">
          <h4>Step 2ï¼šé¸æ“‡è¨ˆç®—æ™‚é–“ç¯„åœ</h4>
          <p>ç³»çµ±å°‡å¾è³‡æ–™åº«å–å¾—è©²æ™‚æ®µå…§å„é›»è™Ÿçš„ 15 åˆ†é˜æ™‚åºè³‡æ–™é€²è¡Œçµç®—ã€‚</p>
        </div>
        <div class="card">
          <div class="form-row" style="grid-template-columns:1fr 1fr;">
            <div class="form-group"><label class="form-label">èµ·å§‹æœˆä»½</label><input class="form-input" type="month"
                value="2025-01" id="m2-start"></div>
            <div class="form-group"><label class="form-label">çµæŸæœˆä»½</label><input class="form-input" type="month"
                value="2025-06" id="m2-end"></div>
          </div>
          <div
            style="margin-top:0.75rem;padding:0.75rem;background:#F8FAFC;border-radius:var(--radius);border:1px solid var(--border);">
            <p style="margin:0;font-size:0.8125rem;color:var(--text-muted);">ğŸ“Œ ç³»çµ±å°‡è‡ªå‹•å¾ DB è¼‰å…¥æ‰€é¸æ™‚æ®µçš„ 15 åˆ†é˜ç™¼é›» / ç”¨é›»æ•¸æ“š</p>
          </div>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;">
          <button class="btn btn-outline" onclick="showM2Step(1)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="showM2Step(3)">ä¸‹ä¸€æ­¥ â†’</button>
        </div>
      </div>

      <!-- M2 Step 3: Contract Config -->
      <div class="m2-step" id="m2-step-3" style="display:none;">
        <div class="banner purple">
          <h4>Step 3ï¼šå¥‘ç´„åƒæ•¸è¨­å®š</h4>
          <p>ç‚ºå„ç™¼é›»ç«¯è¨­å®šè½‰ä¾›æ¯”ä¾‹ï¼Œä¸¦ç‚ºå„ç”¨é›»é›»è™Ÿå¡«å¯«æ¯æœˆ / æ¯å¹´è½‰ä¾›ä¸Šé™ã€‚å¯ç¢ºèªå„ä¼æ¥­æ•¸æ“šä¾†æºã€‚</p>
        </div>
        <div class="card" style="margin-bottom:1rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ğŸ”‹ ç™¼é›»ç«¯ â€” è½‰ä¾›æ¯”ä¾‹ (Pmi)</h4>
          <table>
            <thead>
              <tr>
                <th>é›»è™Ÿ</th>
                <th>æ¡ˆå ´åç¨±</th>
                <th>é¡å‹</th>
                <th>å®¹é‡(kW)</th>
                <th>æ”¶è³¼åƒ¹</th>
                <th>è½‰ä¾›æ¯”ä¾‹(%)</th>
                <th>æ•¸æ“šä¾†æº</th>
              </tr>
            </thead>
            <tbody id="m2-gen-table-body">
              <tr>
                <td>GEN-001</td>
                <td>å¤©èƒ½å¤ªé™½èƒ½ä¸€å» </td>
                <td>â˜€ï¸ å¤ªé™½èƒ½</td>
                <td><input class="form-input" type="number" value="500" min="0" style="width:80px;"></td>
                <td><input class="form-input" type="number" value="4.20" min="0" step="0.01" style="width:90px;"> å…ƒ/åº¦
                </td>
                <td><input class="form-input" type="number" value="100" min="0" max="100" style="width:80px;"></td>
                <td><span class="source-tag db">ğŸ“¦ DB</span></td>
              </tr>
              <tr>
                <td>GEN-002</td>
                <td>å¤©èƒ½å¤ªé™½èƒ½äºŒå» </td>
                <td>â˜€ï¸ å¤ªé™½èƒ½</td>
                <td><input class="form-input" type="number" value="300" min="0" style="width:80px;"></td>
                <td><input class="form-input" type="number" value="4.50" min="0" step="0.01" style="width:90px;"> å…ƒ/åº¦
                </td>
                <td><input class="form-input" type="number" value="100" min="0" max="100" style="width:80px;"></td>
                <td><span class="source-tag db">ğŸ“¦ DB</span></td>
              </tr>
              <tr>
                <td>GEN-003</td>
                <td>å¤©èƒ½é¢¨åŠ›ç™¼é›»å» </td>
                <td>ğŸŒŠ é¢¨åŠ›</td>
                <td><input class="form-input" type="number" value="800" min="0" style="width:80px;"></td>
                <td><input class="form-input" type="number" value="3.80" min="0" step="0.01" style="width:90px;"> å…ƒ/åº¦
                </td>
                <td><input class="form-input" type="number" value="80" min="0" max="100" style="width:80px;"></td>
                <td><span class="source-tag db">ğŸ“¦ DB</span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ğŸ¢ ç”¨é›»ç«¯ â€” æœˆä¸Šé™ (Mni) & å¹´ä¸Šé™ (Yni)</h4>
          <table>
            <thead>
              <tr>
                <th>é›»è™Ÿ</th>
                <th>ä¼æ¥­åç¨±</th>
                <th>å”®é›»åƒ¹</th>
                <th>æ¯æœˆä¸Šé™ (kWh)</th>
                <th>æ¯å¹´ä¸Šé™ (kWh)</th>
                <th>æ•¸æ“šä¾†æº</th>
              </tr>
            </thead>
            <tbody id="m2-usr-table-body">
              <tr>
                <td>USR-001</td>
                <td>å°ç©é›»ç«¹ç§‘å» </td>
                <td><input class="form-input" type="number" value="5.00" min="0" step="0.01" style="width:80px;"> å…ƒ/åº¦
                </td>
                <td><input class="form-input" type="number" value="50000" style="width:100px;"></td>
                <td><input class="form-input" type="number" value="500000" style="width:110px;"></td>
                <td><span class="source-tag db">ğŸ“¦ DB</span></td>
              </tr>
              <tr>
                <td>USR-002</td>
                <td>è¯è¯é›»å­ç¸½éƒ¨</td>
                <td><input class="form-input" type="number" value="5.20" min="0" step="0.01" style="width:80px;"> å…ƒ/åº¦
                </td>
                <td><input class="form-input" type="number" value="30000" style="width:100px;"></td>
                <td><input class="form-input" type="number" value="300000" style="width:110px;"></td>
                <td><span class="source-tag db">ğŸ“¦ DB</span></td>
              </tr>
              <tr>
                <td>USR-003</td>
                <td>å…¨å®¶ä¾¿åˆ©å•†åº—Aå€</td>
                <td><input class="form-input" type="number" value="5.50" min="0" step="0.01" style="width:80px;"> å…ƒ/åº¦
                </td>
                <td><input class="form-input" type="number" value="15000" style="width:100px;"></td>
                <td><input class="form-input" type="number" value="150000" style="width:110px;"></td>
                <td><span class="source-tag db">ğŸ“¦ DB</span></td>
              </tr>
              <tr>
                <td>USR-004</td>
                <td>é æ±ç™¾è²¨æ¿æ©‹åº—</td>
                <td><input class="form-input" type="number" value="5.30" min="0" step="0.01" style="width:80px;"> å…ƒ/åº¦
                </td>
                <td><input class="form-input" type="number" value="25000" style="width:100px;"></td>
                <td><input class="form-input" type="number" value="250000" style="width:110px;"></td>
                <td><span class="source-tag db">ğŸ“¦ DB</span></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;">
          <button class="btn btn-outline" onclick="showM2Step(2)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="showM2Step(4)">ä¸‹ä¸€æ­¥ï¼šç¢ºèªè¼¸å…¥ â†’</button>
        </div>
      </div>

      <!-- M2 Step 4: Confirm -->
      <div class="m2-step" id="m2-step-4" style="display:none;">
        <div class="banner green">
          <h4>Step 4ï¼šç¢ºèªè¼¸å…¥è³‡æ–™</h4>
          <p>è«‹ç¢ºèªä»¥ä¸‹è¨­å®šæ˜¯å¦æ­£ç¢ºï¼Œç¢ºèªå¾Œç³»çµ±å°‡åŸ·è¡Œå…©éšæ®µåª’åˆçµç®—ã€‚</p>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin:1rem 0;">
          <div class="card">
            <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.5rem;">ğŸ“… è¨ˆç®—ç¯„åœ</h4>
            <p style="font-size:0.875rem;">2025-01 ~ 2025-06ï¼ˆå…± 6 å€‹æœˆï¼‰</p>
          </div>
          <div class="card">
            <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.5rem;">ğŸ“Š æ•¸æ“šè¦æ¨¡</h4>
            <p style="font-size:0.875rem;">ç™¼é›»ç«¯ 3 å€‹é›»è™Ÿ Ã— ç”¨é›»ç«¯ 4 å€‹é›»è™Ÿ</p>
          </div>
        </div>
        <div class="card" style="margin-bottom:1rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ğŸ”‹ ç™¼é›»ç«¯è¨­å®šæ‘˜è¦</h4>
          <table>
            <thead>
              <tr>
                <th>é›»è™Ÿ</th>
                <th>æ¡ˆå ´</th>
                <th>è½‰ä¾›æ¯”ä¾‹</th>
                <th>15åˆ†é˜è³‡æ–™</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>GEN-001</td>
                <td>å¤©èƒ½å¤ªé™½èƒ½ä¸€å» </td>
                <td>100%</td>
                <td>âœ… å·²è¼‰å…¥ (17,568 ç­†)</td>
              </tr>
              <tr>
                <td>GEN-002</td>
                <td>å¤©èƒ½å¤ªé™½èƒ½äºŒå» </td>
                <td>100%</td>
                <td>âœ… å·²è¼‰å…¥ (17,568 ç­†)</td>
              </tr>
              <tr>
                <td>GEN-003</td>
                <td>å¤©èƒ½é¢¨åŠ›ç™¼é›»å» </td>
                <td>80%</td>
                <td>âœ… å·²è¼‰å…¥ (17,568 ç­†)</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card" style="margin-bottom:1rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ğŸ¢ ç”¨é›»ç«¯è¨­å®šæ‘˜è¦</h4>
          <table>
            <thead>
              <tr>
                <th>é›»è™Ÿ</th>
                <th>ä¼æ¥­</th>
                <th>æœˆä¸Šé™</th>
                <th>å¹´ä¸Šé™</th>
                <th>15åˆ†é˜è³‡æ–™</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>USR-001</td>
                <td>å°ç©é›»ç«¹ç§‘å» </td>
                <td>50,000</td>
                <td>500,000</td>
                <td>âœ… å·²è¼‰å…¥ (17,568 ç­†)</td>
              </tr>
              <tr>
                <td>USR-002</td>
                <td>è¯è¯é›»å­ç¸½éƒ¨</td>
                <td>30,000</td>
                <td>300,000</td>
                <td>âœ… å·²è¼‰å…¥ (17,568 ç­†)</td>
              </tr>
              <tr>
                <td>USR-003</td>
                <td>å…¨å®¶ä¾¿åˆ©å•†åº—Aå€</td>
                <td>15,000</td>
                <td>150,000</td>
                <td>âœ… å·²è¼‰å…¥ (17,568 ç­†)</td>
              </tr>
              <tr>
                <td>USR-004</td>
                <td>é æ±ç™¾è²¨æ¿æ©‹åº—</td>
                <td>25,000</td>
                <td>250,000</td>
                <td>âœ… å·²è¼‰å…¥ (17,568 ç­†)</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="display:flex;gap:0.75rem;">
          <button class="btn btn-outline" onclick="showM2Step(3)">â† ä¿®æ”¹è¨­å®š</button>
          <button class="btn btn-primary" style="flex:1;" onclick="runSettlement()">âš¡ ç¢ºèªç„¡èª¤ï¼ŒåŸ·è¡Œå…©éšæ®µåª’åˆçµç®—</button>
        </div>
      </div>

      <!-- M2 Step 5: Results -->
      <div class="m2-step" id="m2-step-5" style="display:none;">
        <div class="banner green">
          <h4>çµç®—çµæœï¼ˆ2025-01 è‡³ 2025-06ï¼‰</h4>
          <p>ä»¥ä¸‹ç‚ºä¾å°é›»è¦ç« è¨ˆç®—ä¹‹å„æœˆçµç®—æ˜ç´°ã€‚</p>
        </div>

        <div class="flow-steps" style="margin-top:1rem;">
          <div class="flow-step" style="background:#EEF2FF;border-color:var(--accent);">
            <h5>ç¬¬ä¸€éšæ®µåˆè¨ˆ</h5>
            <p>15 åˆ†é˜å³æ™‚åª’åˆ</p>
            <p style="font-size:1.25rem;font-weight:700;color:var(--accent);margin-top:0.5rem;">1,710,000 kWh</p>
          </div>
          <div style="display:flex;align-items:center;font-size:1.5rem;color:var(--text-tertiary);">â†’</div>
          <div class="flow-step" style="background:#F5F3FF;border-color:#8B5CF6;">
            <h5>ç¬¬äºŒéšæ®µåˆè¨ˆ</h5>
            <p>åŒé›»åƒ¹æ™‚æ®µé¤˜é›»å†åª’åˆ</p>
            <p style="font-size:1.25rem;font-weight:700;color:#8B5CF6;margin-top:0.5rem;">253,800 kWh</p>
          </div>
          <div style="display:flex;align-items:center;font-size:1.5rem;color:var(--text-tertiary);">â†’</div>
          <div class="flow-step" style="background:#F0FDF4;border-color:var(--success);">
            <h5>ç¸½è½‰ä¾›é‡</h5>
            <p>å–æ•´æ•¸ï¼ˆå››æ¨äº”å…¥ï¼‰</p>
            <p style="font-size:1.25rem;font-weight:700;color:var(--success);margin-top:0.5rem;">1,963,800 kWh</p>
          </div>
        </div>

        <div class="metrics">
          <div class="metric green">
            <div class="m-label">ç¸½è½‰ä¾›é‡</div>
            <div class="m-value">1,963,800</div>
            <div class="m-sub">kWhï¼ˆ6å€‹æœˆåˆè¨ˆï¼‰</div>
          </div>
          <div class="metric red">
            <div class="m-label">ç™¼é›»ç«¯é¤˜é›» (Bmi)</div>
            <div class="m-value">91,200</div>
            <div class="m-sub">kWh</div>
          </div>
          <div class="metric purple">
            <div class="m-label">ç”¨é›»ç«¯ç¼ºå£ (Sni)</div>
            <div class="m-value">547,800</div>
            <div class="m-sub">kWh</div>
          </div>
        </div>

        <!-- Monthly tabs -->
        <div class="card" style="margin-top:1rem;">
          <h4 style="font-size:0.9375rem;font-weight:600;margin-bottom:0.75rem;">ğŸ“… å„æœˆçµç®—æ˜ç´°</h4>
          <div class="tabs" id="m2-month-tabs">
            <div class="tab active" onclick="showM2Month(0)">1æœˆ</div>
            <div class="tab" onclick="showM2Month(1)">2æœˆ</div>
            <div class="tab" onclick="showM2Month(2)">3æœˆ</div>
            <div class="tab" onclick="showM2Month(3)">4æœˆ</div>
            <div class="tab" onclick="showM2Month(4)">5æœˆ</div>
            <div class="tab" onclick="showM2Month(5)">6æœˆ</div>
          </div>
          <div id="m2-month-content"></div>
        </div>

      </div>
    </div>

    <!-- MODULE 3 -->
    <div class="page" id="page-m3">
      <h1 class="page-header">ğŸ¯ æ¨¡çµ„ä¸‰ï¼šè½‰ä¾›é…ç½®æœ€ä½³åŒ–</h1>
      <p class="page-subtitle">åœ¨æ•¸è¬ç¨®ç™¼é›»-ç”¨é›»çµ„åˆä¸­ï¼Œåˆ©ç”¨æœ€ä½³åŒ–æ¼”ç®—æ³•æ‰¾å‡ºæœ€å¤§åŒ–æ¯›åˆ©çš„æœ€ä½³é…å°æ–¹æ¡ˆã€‚</p>

      <div class="stepper">
        <div class="st-item active" id="st1" onclick="showOptStep(1)">â‘  é¸æ“‡ç¯„åœ</div>
        <span class="st-arrow">â†’</span>
        <div class="st-item" id="st2" onclick="showOptStep(2)">â‘¡ è¨­å®šç´„æŸ</div>
        <span class="st-arrow">â†’</span>
        <div class="st-item" id="st3" onclick="showOptStep(3)">â‘¢ ç¢ºèªè¼¸å…¥</div>
        <span class="st-arrow">â†’</span>
        <div class="st-item" id="st4" onclick="showOptStep(4)">â‘£ æŸ¥çœ‹çµæœ</div>
      </div>

      <!-- Step 1: Company Selection (with manual entry) -->
      <div class="opt-step" id="opt-step-1">
        <div class="banner">
          <h4>Step 1ï¼šé¸æ“‡åƒèˆ‡å„ªåŒ–çš„ç¯„åœ</h4>
          <p>å‹¾é¸è¦åƒèˆ‡æœ¬æ¬¡å„ªåŒ–çš„ç™¼é›»ç«¯èˆ‡ç”¨é›»ç«¯ã€‚è‹¥ä¼æ¥­ä¸åœ¨è³‡æ–™åº«ä¸­ï¼Œå¯æ‰‹å‹•æ–°å¢ã€‚</p>
        </div>
        <div
          style="margin-bottom:0.75rem;padding:0.625rem 0.875rem;background:#FEF3C7;border:1px solid #FDE68A;border-radius:var(--radius);display:flex;align-items:center;gap:0.5rem;">
          <input type="checkbox" id="m3-exclude-taipower" onchange="toggleTaipowerExclude(this.checked)"
            style="width:16px;height:16px;cursor:pointer;">
          <label for="m3-exclude-taipower"
            style="font-size:0.8125rem;font-weight:500;color:#946e28;cursor:pointer;margin:0;">ä¸è€ƒæ…®å·²ç°½è½‰ä¾›å¥‘ç´„ç™¼é›»ç«¯</label>
          <span style="font-size:0.6875rem;color:#B45309;margin-left:auto;">å·²ç°½å°é›»è½‰ä¾›å¥‘ç´„ä¹‹æ¡ˆå ´å°‡ä¸åƒèˆ‡æœ€ä½³åŒ–</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
          <!-- Generator Side -->
          <div>
            <label class="form-label" style="margin-bottom:0.75rem;">ğŸ”‹ ç™¼é›»ç«¯ï¼ˆå‹¾é¸åƒèˆ‡å„ªåŒ–ï¼‰</label>
            <div class="check-list" style="grid-template-columns:1fr;" id="m3-gen-list">
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> â˜€ï¸ GEN-001
                å¤©èƒ½å¤ªé™½èƒ½ä¸€å»  500kWï¼ˆæ”¶è³¼åƒ¹ 4.20ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> â˜€ï¸ GEN-002
                å¤©èƒ½å¤ªé™½èƒ½äºŒå»  300kWï¼ˆæ”¶è³¼åƒ¹ 4.50ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked" data-taipower="true"><input type="checkbox" checked
                  onchange="toggleCheck(this)"> â˜€ï¸ GEN-003
                å¤©èƒ½å¤ªé™½èƒ½ä¸‰å»  800kWï¼ˆæ”¶è³¼åƒ¹ 3.80ï¼‰<span class="source-tag db">ğŸ“¦ DB</span> <span
                  style="font-size:0.6875rem;color:#DC2626;font-weight:600;">å·²ç°½è½‰ä¾›å¥‘ç´„</span></label>
              <label class="check-item" data-taipower="true"><input type="checkbox" onchange="toggleCheck(this)"> â˜€ï¸
                GEN-004 å¤©èƒ½å¤ªé™½èƒ½å››å» 
                200kWï¼ˆæ”¶è³¼åƒ¹ 4.80ï¼‰<span class="source-tag db">ğŸ“¦ DB</span> <span
                  style="font-size:0.6875rem;color:#DC2626;font-weight:600;">å·²ç°½è½‰ä¾›å¥‘ç´„</span></label>
            </div>
            <button class="btn btn-outline" style="margin-top:0.75rem;width:100%;font-size:0.8125rem;"
              onclick="toggleM3AddForm('gen')">â• æ‰‹å‹•æ–°å¢ç™¼é›»ç«¯æ¡ˆå ´</button>
            <div id="m3-add-gen-form"
              style="display:none;margin-top:0.75rem;padding:1rem;background:#FEFCE8;border:1px solid #FDE68A;border-radius:var(--radius);">
              <h5 style="font-size:0.8125rem;font-weight:600;margin:0 0 0.75rem;color:#92400E;">ğŸ“ æ–°å¢ç™¼é›»ç«¯æ¡ˆå ´</h5>
              <div style="display:grid;gap:0.5rem;">
                <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">æ¡ˆå ´åç¨±</label><input
                    class="form-input" type="text" placeholder="ä¾‹ï¼šXXå¤ªé™½èƒ½é›»å» " id="m3-new-gen-name"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">é¡å‹</label>
                    <select class="form-input" id="m3-new-gen-type">
                      <option value="â˜€ï¸ å¤ªé™½èƒ½">â˜€ï¸ å¤ªé™½èƒ½</option>
                      <option value="ğŸŒŠ é¢¨åŠ›">ğŸŒŠ é¢¨åŠ›</option>
                      <option value="ğŸ’§ æ°´åŠ›">ğŸ’§ æ°´åŠ›</option>
                    </select>
                  </div>
                  <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">å®¹é‡
                      (kW)</label><input class="form-input" type="number" placeholder="500" id="m3-new-gen-cap"></div>
                </div>
                <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">æ”¶è³¼åƒ¹
                    (å…ƒ/åº¦)</label><input class="form-input" type="number" step="0.01" placeholder="4.20"
                    id="m3-new-gen-price"></div>
                <div class="form-group">
                  <label style="font-size:0.75rem;color:var(--text-muted);">ä¸Šå‚³ç™¼é›»æ™‚åºè³‡æ–™ (15åˆ†é˜, CSV)</label>
                  <div
                    style="border:1.5px dashed var(--border);border-radius:var(--radius);padding:0.75rem;text-align:center;cursor:pointer;background:#FFFBEB;"
                    onclick="this.querySelector('input').click()">
                    <span style="font-size:0.8125rem;color:var(--text-muted);">ğŸ“„ é»æ“Šä¸Šå‚³ .csv / .xlsx</span>
                    <input type="file" accept=".csv,.xlsx" style="display:none;"
                      onchange="this.parentElement.innerHTML='<span style=\'font-size:0.8125rem;color:#065F46;\'>âœ… '+this.files[0].name+'</span>'">
                  </div>
                </div>
                <button class="btn btn-primary" style="font-size:0.8125rem;" onclick="addM3Company('gen')">âœ“
                  åŠ å…¥åˆ—è¡¨</button>
              </div>
            </div>
          </div>
          <!-- Consumer Side -->
          <div>
            <label class="form-label" style="margin-bottom:0.75rem;">ğŸ¢ ç”¨é›»ç«¯ï¼ˆå‹¾é¸åƒèˆ‡å„ªåŒ–ï¼‰</label>
            <div class="check-list" style="grid-template-columns:1fr;" id="m3-usr-list">
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ­ USR-001
                å°ç©é›»ç«¹ç§‘å» ï¼ˆå”®é›»åƒ¹ 5.00ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ¢ USR-002
                è¯è¯é›»å­ç¸½éƒ¨ï¼ˆå”®é›»åƒ¹ 5.20ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸª USR-003
                å…¨å®¶ä¾¿åˆ©å•†åº—Aå€ï¼ˆå”®é›»åƒ¹ 5.50ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item checked"><input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ¬ USR-004
                é æ±ç™¾è²¨æ¿æ©‹åº—ï¼ˆå”®é›»åƒ¹ 5.30ï¼‰<span class="source-tag db">ğŸ“¦ DB</span></label>
              <label class="check-item"><input type="checkbox" onchange="toggleCheck(this)"> ğŸ¢ USR-005 è¾¦å…¬å‹ï¼ˆå”®é›»åƒ¹ 4.90ï¼‰
                <span class="source-tag db">ğŸ“¦ DB</span></label>
            </div>
            <button class="btn btn-outline" style="margin-top:0.75rem;width:100%;font-size:0.8125rem;"
              onclick="toggleM3AddForm('usr')">â• æ‰‹å‹•æ–°å¢ç”¨é›»ç«¯ä¼æ¥­</button>
            <div id="m3-add-usr-form"
              style="display:none;margin-top:0.75rem;padding:1rem;background:#EFF6FF;border:1px solid #BFDBFE;border-radius:var(--radius);">
              <h5 style="font-size:0.8125rem;font-weight:600;margin:0 0 0.75rem;color:#1E40AF;">ğŸ“ æ–°å¢ç”¨é›»ç«¯ä¼æ¥­</h5>
              <div style="display:grid;gap:0.5rem;">
                <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">ä¼æ¥­åç¨±</label><input
                    class="form-input" type="text" placeholder="ä¾‹ï¼šXXç§‘æŠ€" id="m3-new-usr-name"></div>
                <div class="form-group"><label style="font-size:0.75rem;color:var(--text-muted);">å”®é›»åƒ¹
                    (å…ƒ/åº¦)</label><input class="form-input" type="number" step="0.01" placeholder="5.00"
                    id="m3-new-usr-price"></div>
                <div class="form-group">
                  <label style="font-size:0.75rem;color:var(--text-muted);">ä¸Šå‚³ç”¨é›»æ™‚åºè³‡æ–™ (15åˆ†é˜, CSV)</label>
                  <div
                    style="border:1.5px dashed var(--border);border-radius:var(--radius);padding:0.75rem;text-align:center;cursor:pointer;background:#EFF6FF;"
                    onclick="this.querySelector('input').click()">
                    <span style="font-size:0.8125rem;color:var(--text-muted);">ğŸ“„ é»æ“Šä¸Šå‚³ .csv / .xlsx</span>
                    <input type="file" accept=".csv,.xlsx" style="display:none;"
                      onchange="this.parentElement.innerHTML='<span style=\'font-size:0.8125rem;color:#065F46;\'>âœ… '+this.files[0].name+'</span>'">
                  </div>
                </div>
                <button class="btn btn-primary" style="font-size:0.8125rem;" onclick="addM3Company('usr')">âœ“
                  åŠ å…¥åˆ—è¡¨</button>
              </div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" style="margin-top:1rem;" onclick="showOptStep(2)">ä¸‹ä¸€æ­¥ â†’</button>
      </div>

      <!-- Step 2: Constraints -->
      <div class="opt-step" id="opt-step-2" style="display:none;">
        <div class="banner purple">
          <h4>Step 2ï¼šè¨­å®šç´„æŸæ¢ä»¶</h4>
          <p>è¨­å®šä¿æ”¶é‡ã€ä¿ä¾›é‡åŠé›»è™Ÿç¶å®šç­‰ç´„æŸã€‚æ¼”ç®—æ³•æœƒè‡ªå‹•éµå®ˆé€™äº›é™åˆ¶ã€‚</p>
        </div>
        <div class="card" style="margin-bottom:1.5rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">âš™ï¸ å…¨åŸŸåƒæ•¸</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label" style="margin-bottom:0.375rem;">æœ€å¤§ç¸½å¥‘ç´„æ•¸</label>
              <input class="form-input" type="number" value="10" min="1" style="width:120px;" id="m3-max-contracts">
              <p style="font-size:0.6875rem;color:var(--text-tertiary);margin-top:0.25rem;">æ¼”ç®—æ³•ç”¢å‡ºçš„å¥‘ç´„ç¸½æ•¸ä¸æœƒè¶…éæ­¤ä¸Šé™</p>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label" style="margin-bottom:0.375rem;">ç™¼é›»å¥‘ç´„å¯æ‹†åˆ†æ•¸</label>
              <input class="form-input" type="number" value="3" min="1" style="width:120px;" id="m3-gen-split">
              <p style="font-size:0.6875rem;color:var(--text-tertiary);margin-top:0.25rem;">æ¯å€‹ç™¼é›»ç«¯å¯è¢«æ‹†åˆ†é…å°è‡³çš„æœ€å¤§ç”¨é›»ç«¯æ•¸é‡</p>
            </div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
          <div class="card">
            <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ç™¼é›»ç«¯ç´„æŸ</h4>
            <table>
              <thead>
                <tr>
                  <th>é›»è™Ÿ</th>
                  <th>ä¿æ”¶é‡(kWh)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>GEN-001</td>
                  <td><input class="form-input" value="200000" style="width:100px;"></td>
                </tr>
                <tr>
                  <td>GEN-002</td>
                  <td><input class="form-input" value="120000" style="width:100px;"></td>
                </tr>
                <tr>
                  <td>GEN-003</td>
                  <td><input class="form-input" value="350000" style="width:100px;"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="card">
            <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ç”¨é›»ç«¯ç´„æŸ</h4>
            <table>
              <thead>
                <tr>
                  <th>é›»è™Ÿ</th>
                  <th>ä¿ä¾›é‡(kWh)</th>
                  <th>é›»è™Ÿç¶å®šæ¨¡å¼</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>USR-001</td>
                  <td><input class="form-input" value="300000" style="width:100px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option selected>ç¨ç«‹</option>
                      <option>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                </tr>
                <tr>
                  <td>USR-002</td>
                  <td><input class="form-input" value="150000" style="width:100px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option>ç¨ç«‹</option>
                      <option selected>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                </tr>
                <tr>
                  <td>USR-003</td>
                  <td><input class="form-input" value="80000" style="width:100px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option selected>ç¨ç«‹</option>
                      <option>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                </tr>
                <tr>
                  <td>USR-004</td>
                  <td><input class="form-input" value="120000" style="width:100px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option>ç¨ç«‹</option>
                      <option selected>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:1rem;">
          <button class="btn btn-outline" onclick="showOptStep(1)">â† ä¸Šä¸€æ­¥</button>
          <button class="btn btn-primary" onclick="showOptStep(3)">ä¸‹ä¸€æ­¥ï¼šç¢ºèªè¼¸å…¥ â†’</button>
        </div>
      </div>

      <!-- Step 3: Confirm All Inputs (Editable) -->
      <div class="opt-step" id="opt-step-3" style="display:none;">
        <div class="banner" style="border-left-color:#F59E0B;">
          <h4>Step 3ï¼šç¢ºèªæ‰€æœ‰è¼¸å…¥</h4>
          <p>è«‹ç¢ºèªä»¥ä¸‹æ‰€æœ‰åƒèˆ‡æœ€ä½³åŒ–çš„æ¡ˆå ´èˆ‡ç´„æŸè¨­å®šã€‚æ•¸å€¼ä»å¯ç›´æ¥ä¿®æ”¹ã€‚</p>
        </div>
        <!-- Generator Confirmation Table -->
        <div class="card" style="margin-bottom:1rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">âš™ï¸ å…¨åŸŸåƒæ•¸</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
            <div style="padding:0.75rem;background:var(--muted);border-radius:var(--radius);">
              <span
                style="font-size:0.75rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.06em;">æœ€å¤§ç¸½å¥‘ç´„æ•¸</span>
              <div style="font-size:1.125rem;font-weight:700;color:var(--primary);margin-top:0.25rem;"
                id="m3-confirm-max-contracts">10</div>
            </div>
            <div style="padding:0.75rem;background:var(--muted);border-radius:var(--radius);">
              <span
                style="font-size:0.75rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;letter-spacing:0.06em;">ç™¼é›»å¥‘ç´„å¯æ‹†åˆ†æ•¸</span>
              <div style="font-size:1.125rem;font-weight:700;color:var(--primary);margin-top:0.25rem;"
                id="m3-confirm-gen-split">3</div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-bottom:1rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ğŸ”‹ ç™¼é›»ç«¯æ¡ˆå ´</h4>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>é›»è™Ÿ</th>
                  <th>æ¡ˆå ´åç¨±</th>
                  <th>é¡å‹</th>
                  <th>å®¹é‡(kW)</th>
                  <th>æ”¶è³¼åƒ¹(å…ƒ/åº¦)</th>
                  <th>ä¿æ”¶é‡(kWh)</th>
                  <th>æ•¸æ“šä¾†æº</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>GEN-001</td>
                  <td>å¤©èƒ½å¤ªé™½èƒ½ä¸€å» </td>
                  <td>â˜€ï¸ å¤ªé™½èƒ½</td>
                  <td><input class="form-input" type="number" value="500" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="4.20" step="0.01" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="200000" style="width:95px;"></td>
                  <td><span class="source-tag db">ğŸ“¦ DB</span></td>
                </tr>
                <tr>
                  <td>GEN-002</td>
                  <td>å¤©èƒ½å¤ªé™½èƒ½äºŒå» </td>
                  <td>â˜€ï¸ å¤ªé™½èƒ½</td>
                  <td><input class="form-input" type="number" value="300" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="4.50" step="0.01" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="120000" style="width:95px;"></td>
                  <td><span class="source-tag db">ğŸ“¦ DB</span></td>
                </tr>
                <tr>
                  <td>GEN-003</td>
                  <td>å¤©èƒ½å¤ªé™½èƒ½ä¸‰å» </td>
                  <td>â˜€ï¸ å¤ªé™½èƒ½</td>
                  <td><input class="form-input" type="number" value="800" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="3.80" step="0.01" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="350000" style="width:95px;"></td>
                  <td><span class="source-tag db">ğŸ“¦ DB</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- Consumer Confirmation Table -->
        <div class="card" style="margin-bottom:1rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ğŸ¢ ç”¨é›»ç«¯ä¼æ¥­</h4>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>é›»è™Ÿ</th>
                  <th>ä¼æ¥­åç¨±</th>
                  <th>å”®é›»åƒ¹(å…ƒ/åº¦)</th>
                  <th>ä¿ä¾›é‡(kWh)</th>
                  <th>é›»è™Ÿç¶å®šæ¨¡å¼</th>
                  <th>æ•¸æ“šä¾†æº</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>USR-001</td>
                  <td>å°ç©é›»ç«¹ç§‘å» </td>
                  <td><input class="form-input" type="number" value="5.00" step="0.01" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="300000" style="width:95px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option selected>ç¨ç«‹</option>
                      <option>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                  <td><span class="source-tag db">ğŸ“¦ DB</span></td>
                </tr>
                <tr>
                  <td>USR-002</td>
                  <td>è¯è¯é›»å­ç¸½éƒ¨</td>
                  <td><input class="form-input" type="number" value="5.20" step="0.01" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="150000" style="width:95px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option>ç¨ç«‹</option>
                      <option selected>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                  <td><span class="source-tag db">ğŸ“¦ DB</span></td>
                </tr>
                <tr>
                  <td>USR-003</td>
                  <td>å…¨å®¶ä¾¿åˆ©å•†åº—Aå€</td>
                  <td><input class="form-input" type="number" value="5.50" step="0.01" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="80000" style="width:95px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option selected>ç¨ç«‹</option>
                      <option>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                  <td><span class="source-tag db">ğŸ“¦ DB</span></td>
                </tr>
                <tr>
                  <td>USR-004</td>
                  <td>é æ±ç™¾è²¨æ¿æ©‹åº—</td>
                  <td><input class="form-input" type="number" value="5.30" step="0.01" style="width:75px;"></td>
                  <td><input class="form-input" type="number" value="120000" style="width:95px;"></td>
                  <td><select class="form-input" style="width:120px;">
                      <option>ç¨ç«‹</option>
                      <option selected>åŒä¼æ¥­</option>
                      <option>å…è¨±è·¨ä¼æ¥­</option>
                    </select></td>
                  <td><span class="source-tag db">ğŸ“¦ DB</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div
          style="padding:0.75rem 1rem;background:#FFFBEB;border:1px solid #FDE68A;border-radius:var(--radius);margin-bottom:1rem;">
          <p style="margin:0;font-size:0.8125rem;color:#92400E;">âš ï¸ ç¢ºèªç„¡èª¤å¾Œï¼Œé»æ“Šä¸‹æ–¹ã€Œé–‹å§‹æœ€ä½³åŒ–ã€åŸ·è¡Œæ¼”ç®—æ³•ã€‚ä¸Šæ–¹æ•¸å€¼ä»å¯ç›´æ¥ä¿®æ”¹ã€‚</p>
        </div>
        <div style="display:flex;gap:0.75rem;margin-bottom:1.5rem;">
          <button class="btn btn-outline" onclick="showOptStep(2)">â† ä¸Šä¸€æ­¥</button>
        </div>
        <div class="card" style="text-align:center;padding:2rem;">
          <div id="ga-idle">
            <p style="font-size:0.875rem;color:var(--text-muted);margin-bottom:1rem;">è¨­å®šå®Œæˆï¼Œé»æ“Šé–‹å§‹åŸ·è¡Œæœ€ä½³åŒ–æ¼”ç®—æ³•</p>
            <button class="btn btn-primary" onclick="runGA()">ğŸš€ é–‹å§‹æœ€ä½³åŒ–</button>
          </div>
          <div id="ga-running" style="display:none;">
            <p style="font-size:0.875rem;font-weight:600;margin-bottom:0.5rem;">ğŸ”„ æœ€ä½³åŒ–é€²è¡Œä¸­...</p>
            <div class="progress-bar">
              <div class="progress-fill" id="ga-progress" style="width:0%;"></div>
            </div>
            <p style="font-size:0.75rem;color:var(--text-muted);" id="ga-status">åˆå§‹åŒ–æ—ç¾¤...</p>
          </div>
          <div id="ga-done" style="display:none;">
            <p style="font-size:1.25rem;margin-bottom:0.5rem;">âœ…</p>
            <p style="font-size:0.875rem;font-weight:600;color:var(--success-dark);">æœ€ä½³åŒ–å®Œæˆï¼æ‰¾åˆ°æœ€ä½³é…å°æ–¹æ¡ˆ</p>
            <button class="btn btn-success" style="margin-top:1rem;" onclick="showOptStep(4)">æŸ¥çœ‹çµæœ â†’</button>
          </div>
        </div>
      </div>

      <!-- Step 4: Results (Optimized Only) -->
      <div class="opt-step" id="opt-step-4" style="display:none;">
        <div class="banner green">
          <h4>Step 4ï¼šæœ€ä½³åŒ–çµæœ</h4>
          <p>ä»¥ä¸‹ç‚ºæ¼”ç®—æ³•æœ€ä½³åŒ–å¾Œçš„é…å°æ–¹æ¡ˆç¸½è¦½èˆ‡å¥‘ç´„åˆ†é…æ˜ç´°ã€‚</p>
        </div>

        <!-- Summary Metrics -->
        <div class="metrics" style="grid-template-columns:repeat(5,1fr);margin-bottom:1.5rem;">
          <div class="metric green" style="border-left-width:4px;">
            <div class="m-label">ç¸½æ¯›åˆ©</div>
            <div class="m-value" style="color:var(--success);">$517,160</div>
          </div>
          <div class="metric green" style="border-left-width:4px;">
            <div class="m-label">è½‰ä¾›é‡</div>
            <div class="m-value">416,800</div>
            <div class="m-sub">kWh</div>
          </div>
          <div class="metric" style="border-left-width:4px;">
            <div class="m-label">é¤˜é›»é‡</div>
            <div class="m-value">5,200</div>
            <div class="m-sub">kWh</div>
          </div>
          <div class="metric" style="border-left-width:4px;">
            <div class="m-label">ç¼ºå£é‡</div>
            <div class="m-value">18,400</div>
            <div class="m-sub">kWh</div>
          </div>
          <div class="metric" style="border-left-width:4px;">
            <div class="m-label">å¥‘ç´„æ•¸</div>
            <div class="m-value">4</div>
            <div class="m-sub">ä»½</div>
          </div>
        </div>

        <!-- Contract Allocation Details -->
        <div class="card" style="margin-bottom:1rem;">
          <h4 style="font-size:0.875rem;font-weight:600;margin-bottom:0.75rem;">ğŸ“‹ å¥‘ç´„åˆ†é…çµæœ</h4>
          <p style="font-size:0.8rem;color:#64748B;margin-bottom:0.75rem;">âš¡ ä¸€ä»½å¥‘ç´„å¯åŒ…å«å¤šå€‹ç™¼é›»ç«¯æˆ–ç”¨é›»ç«¯çš„çµ„åˆé…å°</p>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>å¥‘ç´„</th>
                  <th>ç™¼é›»ç«¯</th>
                  <th>è½‰ä¾›æ¯”ä¾‹</th>
                  <th>ç”¨é›»ç«¯</th>
                  <th>æœˆä¸Šé™ (kWh)</th>
                  <th>å¹´ä¸Šé™ (kWh)</th>
                  <th>é ä¼°è½‰ä¾›é‡</th>
                  <th>é ä¼°æ¯›åˆ©</th>
                </tr>
              </thead>
              <tbody>
                <!-- OPT-001: GEN-003 (100%) â†’ 3 Consumers -->
                <tr style="border-top:2px solid #E2E8F0;">
                  <td rowspan="3"><strong style="color:#3B82F6;">OPT-001</strong><br><span
                      style="font-size:0.7rem;color:#94A3B8;">1å°3</span></td>
                  <td rowspan="3">â˜€ï¸ GEN-003 å¤©èƒ½å¤ªé™½èƒ½ä¸‰å» <br><span style="font-size:0.75rem;color:#94A3B8;">800kW</span></td>
                  <td rowspan="3" style="font-weight:600;">100%</td>
                  <td>ğŸ­ USR-001 å°ç©é›»ç«¹ç§‘å» </td>
                  <td>12,000</td>
                  <td>140,000</td>
                  <td>126,000</td>
                  <td style="color:var(--success);font-weight:600;">$151,200</td>
                </tr>
                <tr>
                  <td>ğŸª USR-003 å…¨å®¶ä¾¿åˆ©å•†åº—Aå€</td>
                  <td>8,000</td>
                  <td>96,000</td>
                  <td>84,000</td>
                  <td style="color:var(--success);font-weight:600;">$142,800</td>
                </tr>
                <tr>
                  <td>ğŸ¬ USR-004 é æ±ç™¾è²¨æ¿æ©‹åº—</td>
                  <td>7,000</td>
                  <td>80,000</td>
                  <td>70,000</td>
                  <td style="color:var(--success);font-weight:600;">$105,000</td>
                </tr>
                <tr style="background:#F0FDF4;font-size:0.8rem;">
                  <td colspan="3" style="text-align:right;font-weight:600;color:#64748B;">OPT-001 å°è¨ˆ</td>
                  <td></td>
                  <td>27,000</td>
                  <td>316,000</td>
                  <td style="font-weight:600;">280,000</td>
                  <td style="color:var(--success);font-weight:700;">$399,000</td>
                </tr>

                <!-- OPT-002: 2 Generators â†’ 1 Consumer (USR-002) -->
                <tr style="border-top:2px solid #E2E8F0;">
                  <td rowspan="2"><strong style="color:#3B82F6;">OPT-002</strong><br><span
                      style="font-size:0.7rem;color:#94A3B8;">2å°1</span></td>
                  <td>â˜€ï¸ GEN-001 å¤©èƒ½å¤ªé™½èƒ½ä¸€å» <br><span style="font-size:0.75rem;color:#94A3B8;">500kW</span></td>
                  <td style="font-weight:600;">35%</td>
                  <td rowspan="2">ğŸ¢ USR-002 è¯è¯é›»å­ç¸½éƒ¨<br><span style="font-size:0.75rem;color:#94A3B8;">å”®é›»åƒ¹ 5.20</span>
                  </td>
                  <td>4,000</td>
                  <td>48,000</td>
                  <td>42,000</td>
                  <td style="color:var(--success);font-weight:600;">$33,600</td>
                </tr>
                <tr>
                  <td>â˜€ï¸ GEN-002 å¤©èƒ½å¤ªé™½èƒ½äºŒå» <br><span style="font-size:0.75rem;color:#94A3B8;">300kW</span></td>
                  <td style="font-weight:600;">40%</td>
                  <td>2,500</td>
                  <td>28,000</td>
                  <td>18,000</td>
                  <td style="color:var(--success);font-weight:600;">$12,600</td>
                </tr>
                <tr style="background:#F0FDF4;font-size:0.8rem;">
                  <td colspan="3" style="text-align:right;font-weight:600;color:#64748B;">OPT-002 å°è¨ˆ</td>
                  <td></td>
                  <td>6,500</td>
                  <td>76,000</td>
                  <td style="font-weight:600;">60,000</td>
                  <td style="color:var(--success);font-weight:700;">$46,200</td>
                </tr>

                <!-- OPT-003: GEN-001 (40%) â†’ USR-001 -->
                <tr style="border-top:2px solid #E2E8F0;">
                  <td><strong style="color:#3B82F6;">OPT-003</strong><br><span
                      style="font-size:0.7rem;color:#94A3B8;">1å°1</span></td>
                  <td>â˜€ï¸ GEN-001 å¤©èƒ½å¤ªé™½èƒ½ä¸€å» <br><span style="font-size:0.75rem;color:#94A3B8;">500kW</span></td>
                  <td style="font-weight:600;">40%</td>
                  <td>ğŸ­ USR-001 å°ç©é›»ç«¹ç§‘å» </td>
                  <td>3,000</td>
                  <td>32,000</td>
                  <td>28,000</td>
                  <td style="color:var(--success);font-weight:600;">$22,400</td>
                </tr>
                <tr style="background:#F0FDF4;font-size:0.8rem;">
                  <td colspan="3" style="text-align:right;font-weight:600;color:#64748B;">OPT-003 å°è¨ˆ</td>
                  <td></td>
                  <td>3,000</td>
                  <td>32,000</td>
                  <td style="font-weight:600;">28,000</td>
                  <td style="color:var(--success);font-weight:700;">$22,400</td>
                </tr>

                <!-- OPT-004: GEN-002 (60%) + GEN-001 (25%) â†’ 2 Consumers -->
                <tr style="border-top:2px solid #E2E8F0;">
                  <td rowspan="4"><strong style="color:#3B82F6;">OPT-004</strong><br><span
                      style="font-size:0.7rem;color:#94A3B8;">2å°2</span></td>
                  <td rowspan="2">â˜€ï¸ GEN-002 å¤©èƒ½å¤ªé™½èƒ½äºŒå» <br><span style="font-size:0.75rem;color:#94A3B8;">300kW</span></td>
                  <td rowspan="2" style="font-weight:600;">60%</td>
                  <td>ğŸª USR-003 å…¨å®¶ä¾¿åˆ©å•†åº—Aå€</td>
                  <td>2,000</td>
                  <td>22,000</td>
                  <td>16,800</td>
                  <td style="color:var(--success);font-weight:600;">$20,160</td>
                </tr>
                <tr>
                  <td>ğŸ¬ USR-004 é æ±ç™¾è²¨æ¿æ©‹åº—</td>
                  <td>1,500</td>
                  <td>16,000</td>
                  <td>10,000</td>
                  <td style="color:var(--success);font-weight:600;">$7,000</td>
                </tr>
                <tr>
                  <td rowspan="2">â˜€ï¸ GEN-001 å¤©èƒ½å¤ªé™½èƒ½ä¸€å» <br><span style="font-size:0.75rem;color:#94A3B8;">500kW å‰©é¤˜</span>
                  </td>
                  <td rowspan="2" style="font-weight:600;">25%</td>
                  <td>ğŸª USR-003 å…¨å®¶ä¾¿åˆ©å•†åº—Aå€</td>
                  <td>1,800</td>
                  <td>20,000</td>
                  <td>14,000</td>
                  <td style="color:var(--success);font-weight:600;">$16,800</td>
                </tr>
                <tr>
                  <td>ğŸ¬ USR-004 é æ±ç™¾è²¨æ¿æ©‹åº—</td>
                  <td>1,200</td>
                  <td>12,000</td>
                  <td>8,000</td>
                  <td style="color:var(--success);font-weight:600;">$5,600</td>
                </tr>
                <tr style="background:#F0FDF4;font-size:0.8rem;">
                  <td colspan="3" style="text-align:right;font-weight:600;color:#64748B;">OPT-004 å°è¨ˆ</td>
                  <td></td>
                  <td>6,500</td>
                  <td>70,000</td>
                  <td style="font-weight:600;">48,800</td>
                  <td style="color:var(--success);font-weight:700;">$49,560</td>
                </tr>

                <!-- Grand Total -->
                <tr style="font-weight:700;background:#DBEAFE;border-top:3px solid #3B82F6;">
                  <td colspan="6">ğŸ“Š ç¸½è¨ˆï¼ˆ4 ä»½å¥‘ç´„ï¼‰</td>
                  <td>416,800</td>
                  <td style="color:var(--success);">$517,160</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div style="display:flex;gap:0.75rem;">
          <button class="btn btn-outline" onclick="showOptStep(1)">â† é‡æ–°è¨­å®š</button>
          <button class="btn btn-primary" onclick="alert('ğŸ“¥ å·²åŒ¯å‡ºæœ€ä½³åŒ–çµæœå ±å‘Š (PDF)')">ğŸ“¥ åŒ¯å‡ºå ±å‘Š</button>
        </div>
      </div>
    </div>

  </main>

  <script>
    // Navigation
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + id).classList.add('active');
      document.querySelectorAll('.nav-step').forEach(n => n.classList.remove('active'));
      const navMap = { m1: 0, m2: 1, m3: 2 };
      if (navMap[id] !== undefined) {
        document.querySelectorAll('.nav-step')[navMap[id]].classList.add('active');
      }
      window.scrollTo(0, 0);
    }

    // Module 1: Step navigation
    function selectUserType(card, type) {
      document.querySelectorAll('.type-card').forEach(c => {
        c.classList.remove('selected');
        c.querySelector('.radio-text').textContent = 'é¸æ“‡';
      });
      card.classList.add('selected');
      card.querySelector('.radio-text').textContent = 'å·²é¸æ“‡';
      document.getElementById('userType').value = type;
    }

    // Module 1: Build 12-month input table (user fills in month)
    (function initM1InputTable() {
      const tbody = document.getElementById('m1-input-tbody');
      for (let i = 0; i < 12; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:0.375rem 0.5rem;border-bottom:1px solid var(--border);">
            <input type="month" class="form-input m1-month" style="padding:0.375rem 0.5rem;min-width:140px;">
          </td>
          <td style="padding:0.375rem 0.5rem;border-bottom:1px solid var(--border);">
            <input type="number" class="form-input m1-peak" data-month="${i}" placeholder="0" min="0" style="text-align:right;padding:0.375rem 0.5rem;" oninput="updateM1Totals()">
          </td>
          <td style="padding:0.375rem 0.5rem;border-bottom:1px solid var(--border);">
            <input type="number" class="form-input m1-mid" data-month="${i}" placeholder="0" min="0" style="text-align:right;padding:0.375rem 0.5rem;" oninput="updateM1Totals()">
          </td>
          <td style="padding:0.375rem 0.5rem;border-bottom:1px solid var(--border);">
            <input type="number" class="form-input m1-off" data-month="${i}" placeholder="0" min="0" style="text-align:right;padding:0.375rem 0.5rem;" oninput="updateM1Totals()">
          </td>
          <td style="padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);text-align:center;font-weight:500;color:var(--text-muted);" class="m1-row-total">0</td>
        `;
        tbody.appendChild(tr);
      }
    })();

    function updateM1Totals() {
      let totalPeak = 0, totalMid = 0, totalOff = 0;
      const rows = document.querySelectorAll('#m1-input-tbody tr');
      rows.forEach(row => {
        const p = parseFloat(row.querySelector('.m1-peak').value) || 0;
        const m = parseFloat(row.querySelector('.m1-mid').value) || 0;
        const o = parseFloat(row.querySelector('.m1-off').value) || 0;
        totalPeak += p;
        totalMid += m;
        totalOff += o;
        row.querySelector('.m1-row-total').textContent = (p + m + o).toLocaleString();
      });
      document.getElementById('m1-total-peak').textContent = totalPeak.toLocaleString();
      document.getElementById('m1-total-mid').textContent = totalMid.toLocaleString();
      document.getElementById('m1-total-off').textContent = totalOff.toLocaleString();
      document.getElementById('m1-total-all').textContent = (totalPeak + totalMid + totalOff).toLocaleString();
    }

    function fillM1Example() {
      const exampleData = [
        { month: '2025-01', peak: 185000, mid: 142000, off: 98000 },
        { month: '2025-02', peak: 172000, mid: 135000, off: 91000 },
        { month: '2025-03', peak: 195000, mid: 148000, off: 103000 },
        { month: '2025-04', peak: 210000, mid: 158000, off: 112000 },
        { month: '2025-05', peak: 238000, mid: 175000, off: 125000 },
        { month: '2025-06', peak: 265000, mid: 195000, off: 138000 },
        { month: '2025-07', peak: 285000, mid: 210000, off: 148000 },
        { month: '2025-08', peak: 278000, mid: 205000, off: 145000 },
        { month: '2025-09', peak: 245000, mid: 180000, off: 128000 },
        { month: '2025-10', peak: 215000, mid: 162000, off: 115000 },
        { month: '2025-11', peak: 192000, mid: 145000, off: 100000 },
        { month: '2025-12', peak: 188000, mid: 140000, off: 96000 }
      ];
      const rows = document.querySelectorAll('#m1-input-tbody tr');
      rows.forEach((row, i) => {
        if (exampleData[i]) {
          row.querySelector('.m1-month').value = exampleData[i].month;
          row.querySelector('.m1-peak').value = exampleData[i].peak;
          row.querySelector('.m1-mid').value = exampleData[i].mid;
          row.querySelector('.m1-off').value = exampleData[i].off;
        }
      });
      updateM1Totals();
    }


    function showM1Step2() {
      document.getElementById('m1-step1').style.display = 'none';
      document.getElementById('m1-step2').style.display = 'block';
    }
    function backToM1Step1() {
      document.getElementById('m1-step2').style.display = 'none';
      document.getElementById('m1-step1').style.display = 'block';
    }
    function exportTimeSeries() {
      alert('ğŸ“¥ å·²åŒ¯å‡º 35,040 ç­† 15 åˆ†é˜æ™‚åºè³‡æ–™ï¼ˆCSV æ ¼å¼ï¼‰\nå¯å°‡æ­¤æª”æ¡ˆåŒ¯å…¥è³‡æ–™åº«ã€‚');
    }

    // Module 1: Simulation â€” generate full-year 35,040 data points
    function runSimulation() {
      // Read user-entered monthly values and compute totals
      let peak = 0, mid = 0, off = 0;
      document.querySelectorAll('.m1-peak').forEach(el => peak += (parseFloat(el.value) || 0));
      document.querySelectorAll('.m1-mid').forEach(el => mid += (parseFloat(el.value) || 0));
      document.querySelectorAll('.m1-off').forEach(el => off += (parseFloat(el.value) || 0));
      if (peak + mid + off === 0) {
        alert('è«‹å…ˆå¡«å…¥è‡³å°‘ä¸€å€‹æœˆçš„ç”¨é›»é‡‘é¡æ•¸æ“š');
        return;
      }
      const total = peak + mid + off;
      document.getElementById('avgKwh').textContent = Math.round(total / 12).toLocaleString();
      document.getElementById('peakRatio').textContent = Math.round(peak / total * 100) + '%';
      document.getElementById('sim-result').style.display = 'block';

      const type = document.getElementById('userType').value;

      // Daily profile templates (96 points per day)
      const dailyProfile = {
        '24h': (i) => 0.85 + Math.random() * 0.3,
        'office': (i) => (i >= 32 && i <= 68) ? 0.65 + Math.random() * 0.55 : 0.08 + Math.random() * 0.12,
        'store': (i) => (i >= 28 && i <= 84) ? 0.55 + Math.random() * 0.45 : 0.12 + Math.random() * 0.1,
        'mall': (i) => (i >= 40 && i <= 88) ? 0.45 + Math.random() * 0.65 : 0.08 + Math.random() * 0.12,
      };

      // Seasonal multiplier (summer months higher)
      const seasonFactor = (month) => {
        const factors = [0.85, 0.82, 0.88, 0.92, 1.0, 1.15, 1.25, 1.22, 1.1, 0.95, 0.88, 0.85];
        return factors[month];
      };

      // Generate 35,040 data points (365 days Ã— 96 intervals)
      const startDate = new Date(2025, 0, 1);
      const chartData = [];
      const chartLabels = [];
      const profFn = dailyProfile[type];
      const dailyBase = total / 96;

      for (let day = 0; day < 365; day++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + day);
        const month = date.getMonth();
        const dayOfWeek = date.getDay();
        const sFactor = seasonFactor(month);
        // Weekend adjustment
        const wFactor = (type === 'office') ? (dayOfWeek === 0 || dayOfWeek === 6 ? 0.25 : 1.0) :
          (type === 'mall') ? (dayOfWeek === 0 || dayOfWeek === 6 ? 1.3 : 1.0) : 1.0;

        for (let interval = 0; interval < 96; interval++) {
          const t = new Date(date);
          t.setMinutes(interval * 15);
          chartLabels.push(t);
          const val = profFn(interval) * dailyBase * sFactor * wFactor * (0.85 + Math.random() * 0.3);
          chartData.push(Math.round(val * 100) / 100);
        }
      }

      // Store for zoom range functions
      window._loadChartStart = startDate;

      const ctx = document.getElementById('chartLoad').getContext('2d');
      if (window.loadChart) window.loadChart.destroy();
      window.loadChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'ç”¨é›»é‡ (kWh)',
            data: chartData,
            borderColor: '#F97316',
            backgroundColor: 'rgba(249,115,22,0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 1.5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => {
                  const d = items[0].label;
                  return d;
                },
                label: (item) => `ç”¨é›»é‡: ${Number(item.raw).toFixed(1)} kWh`
              }
            },
            zoom: {
              pan: { enabled: true, mode: 'x', modifierKey: null },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                drag: { enabled: false },
                mode: 'x'
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'month',
                displayFormats: { hour: 'HH:mm', day: 'M/d', week: 'M/d', month: 'yyyy-MM' }
              },
              grid: { display: false },
              ticks: { maxTicksLimit: 13, font: { size: 10 } }
            },
            y: {
              beginAtZero: true,
              grid: { color: '#F1F5F9' },
              title: { display: true, text: 'kWh', font: { size: 11 } }
            }
          }
        }
      });
    }

    function zoomLoadChart(range) {
      if (!window.loadChart) return;
      const start = new Date(window._loadChartStart);
      let end;
      switch (range) {
        case '1d': end = new Date(start); end.setDate(end.getDate() + 1); break;
        case '1w': end = new Date(start); end.setDate(end.getDate() + 7); break;
        case '1m': end = new Date(start); end.setMonth(end.getMonth() + 1); break;
        case 'all': resetLoadChartZoom(); return;
      }
      window.loadChart.options.scales.x.min = start.getTime();
      window.loadChart.options.scales.x.max = end.getTime();
      // Adjust time unit based on range
      if (range === '1d') window.loadChart.options.scales.x.time.unit = 'hour';
      else if (range === '1w') window.loadChart.options.scales.x.time.unit = 'day';
      else if (range === '1m') window.loadChart.options.scales.x.time.unit = 'day';
      window.loadChart.update();
    }

    function resetLoadChartZoom() {
      if (!window.loadChart) return;
      window.loadChart.resetZoom();
      window.loadChart.options.scales.x.min = undefined;
      window.loadChart.options.scales.x.max = undefined;
      window.loadChart.options.scales.x.time.unit = 'month';
      window.loadChart.update();
    }

    function completeM1() {
      document.getElementById('nav-m1').classList.add('done');
      document.getElementById('nav-m1-circle').className = 'circle done';
      document.getElementById('nav-m1-circle').textContent = 'âœ“';
      document.getElementById('nav-m1-status').textContent = 'âœ“ å®Œæˆ';
      showPage('m2');
    }

    // Module 2: Step navigation
    function showM2Step(n) {
      document.querySelectorAll('.m2-step').forEach(s => s.style.display = 'none');
      document.getElementById('m2-step-' + n).style.display = 'block';
      for (let i = 1; i <= 5; i++) {
        const el = document.getElementById('m2s' + i);
        el.className = 'st-item' + (i === n ? ' active' : (i < n ? ' done' : ''));
      }
      window.scrollTo(0, 0);
    }
    function toggleCheck(cb) { cb.closest('.check-item').classList.toggle('checked', cb.checked); }

    // M2 Manual Company Entry
    let m2GenCounter = 5, m2UsrCounter = 5;
    function toggleM2AddForm(type) {
      const form = document.getElementById('m2-add-' + type + '-form');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }
    function addManualCompany(type) {
      if (type === 'gen') {
        const name = document.getElementById('m2-new-gen-name').value || 'æ–°ç™¼é›»ç«¯ä¼æ¥­';
        const genType = document.getElementById('m2-new-gen-type').value;
        const cap = document.getElementById('m2-new-gen-cap').value || '0';
        const price = document.getElementById('m2-new-gen-price').value || '0';
        const ratio = document.getElementById('m2-new-gen-ratio').value || '100';
        const id = 'GEN-' + String(m2GenCounter++).padStart(3, '0');
        // Add to check list
        const list = document.getElementById('m2-gen-list');
        const label = document.createElement('label');
        label.className = 'check-item checked';
        label.innerHTML = '<input type="checkbox" checked onchange="toggleCheck(this)"> ' + genType.split(' ')[0] + ' ' + name + ' (' + id + ', ' + cap + 'kW) <span class="source-tag manual">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³</span>';
        list.appendChild(label);
        // Add to Step 3 table
        const tbody = document.getElementById('m2-gen-table-body');
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + id + '</td><td>' + name + '</td><td>' + genType + '</td>' +
          '<td><input class="form-input" type="number" value="' + cap + '" min="0" style="width:80px;"></td>' +
          '<td><input class="form-input" type="number" value="' + price + '" min="0" step="0.01" style="width:90px;"> å…ƒ/åº¦</td>' +
          '<td><input class="form-input" type="number" value="' + ratio + '" min="0" max="100" style="width:80px;"></td>' +
          '<td><span class="source-tag manual">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³</span></td>';
        tbody.appendChild(tr);
        // Reset form
        document.getElementById('m2-new-gen-name').value = '';
        document.getElementById('m2-new-gen-cap').value = '';
        document.getElementById('m2-new-gen-price').value = '';
        document.getElementById('m2-add-gen-form').style.display = 'none';
      } else {
        const name = document.getElementById('m2-new-usr-name').value || 'æ–°ç”¨é›»ç«¯ä¼æ¥­';
        const price = document.getElementById('m2-new-usr-price').value || '0';
        const mlimit = document.getElementById('m2-new-usr-mlimit').value || '0';
        const ylimit = document.getElementById('m2-new-usr-ylimit').value || '0';
        const id = 'USR-' + String(m2UsrCounter++).padStart(3, '0');
        // Add to check list
        const list = document.getElementById('m2-usr-list');
        const label = document.createElement('label');
        label.className = 'check-item checked';
        label.innerHTML = '<input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ¢ ' + name + ' (' + id + ') <span class="source-tag manual">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³</span>';
        list.appendChild(label);
        // Add to Step 3 table
        const tbody = document.getElementById('m2-usr-table-body');
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + id + '</td><td>' + name + '</td>' +
          '<td><input class="form-input" type="number" value="' + price + '" min="0" step="0.01" style="width:80px;"> å…ƒ/åº¦</td>' +
          '<td><input class="form-input" type="number" value="' + mlimit + '" style="width:100px;"></td>' +
          '<td><input class="form-input" type="number" value="' + ylimit + '" style="width:110px;"></td>' +
          '<td><span class="source-tag manual">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³</span></td>';
        tbody.appendChild(tr);
        // Reset form
        document.getElementById('m2-new-usr-name').value = '';
        document.getElementById('m2-new-usr-price').value = '';
        document.getElementById('m2-new-usr-mlimit').value = '';
        document.getElementById('m2-new-usr-ylimit').value = '';
        document.getElementById('m2-add-usr-form').style.display = 'none';
      }
    }

    // M2 monthly mock data
    const m2MonthData = [
      { month: '2025-01', p1: 280000, p2: 41000, total: 321000, surplus: 14500, shortage: 89000, peak: 107000, midpeak: 92000, offpeak: 88000, satmid: 34000 },
      { month: '2025-02', p1: 265000, p2: 39200, total: 304200, surplus: 15800, shortage: 95800, peak: 101000, midpeak: 87000, offpeak: 83000, satmid: 33200 },
      { month: '2025-03', p1: 295000, p2: 44000, total: 339000, surplus: 13200, shortage: 81000, peak: 113000, midpeak: 97000, offpeak: 92000, satmid: 37000 },
      { month: '2025-04', p1: 290000, p2: 43500, total: 333500, surplus: 14800, shortage: 86500, peak: 111000, midpeak: 95000, offpeak: 90500, satmid: 37000 },
      { month: '2025-05', p1: 300000, p2: 45100, total: 345100, surplus: 16200, shortage: 94900, peak: 115000, midpeak: 99000, offpeak: 93000, satmid: 38100 },
      { month: '2025-06', p1: 280000, p2: 41000, total: 321000, surplus: 16700, shortage: 100600, peak: 107000, midpeak: 92000, offpeak: 88000, satmid: 34000 },
    ];

    function showM2Month(idx) {
      document.querySelectorAll('#m2-month-tabs .tab').forEach((t, i) => t.className = 'tab' + (i === idx ? ' active' : ''));
      const d = m2MonthData[idx];
      document.getElementById('m2-month-content').innerHTML = `
    <div class="metrics" style="margin:0.75rem 0;">
      <div class="metric"><div class="m-label">Phase 1 åª’åˆé‡</div><div class="m-value">${d.p1.toLocaleString()}</div><div class="m-sub">kWh</div></div>
      <div class="metric purple"><div class="m-label">Phase 2 åª’åˆé‡</div><div class="m-value">${d.p2.toLocaleString()}</div><div class="m-sub">kWh</div></div>
      <div class="metric green"><div class="m-label">ç¸½è½‰ä¾›é‡</div><div class="m-value">${d.total.toLocaleString()}</div><div class="m-sub">kWh</div></div>
      <div class="metric red"><div class="m-label">ç™¼é›»ç«¯é¤˜é›» (Bmi)</div><div class="m-value">${d.surplus.toLocaleString()}</div><div class="m-sub">kWh</div></div>
      <div class="metric purple"><div class="m-label">ç”¨é›»ç«¯ç¼ºå£ (Sni)</div><div class="m-value">${d.shortage.toLocaleString()}</div><div class="m-sub">kWh</div></div>
    </div>
    <h5 style="font-size:0.8125rem;font-weight:600;margin:0.75rem 0 0.5rem;">åˆ†æ™‚æ®µçµ±è¨ˆ</h5>
    <table><thead><tr><th>æ™‚æ®µ</th><th>è½‰ä¾›é‡ (kWh)</th></tr></thead><tbody>
      <tr><td>å°–å³°</td><td>${d.peak.toLocaleString()}</td></tr>
      <tr><td>åŠå°–å³°</td><td>${d.midpeak.toLocaleString()}</td></tr>
      <tr><td>é›¢å³°</td><td>${d.offpeak.toLocaleString()}</td></tr>
      <tr><td>é€±å…­åŠå°–å³°</td><td>${d.satmid.toLocaleString()}</td></tr>
      <tr style="font-weight:600;background:#F8FAFC;"><td>åˆè¨ˆ</td><td>${d.total.toLocaleString()}</td></tr>
    </tbody></table>
  `;
    }

    function runSettlement() {
      showM2Step(5);
      showM2Month(0);

      const ctx = document.getElementById('chartSettle').getContext('2d');
      if (window.settleChart) window.settleChart.destroy();
      const months = m2MonthData.map(d => d.month.slice(5) + 'æœˆ');
      window.settleChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            { label: 'Phase 1', data: m2MonthData.map(d => d.p1), backgroundColor: '#6366F1' },
            { label: 'Phase 2', data: m2MonthData.map(d => d.p2), backgroundColor: '#8B5CF6' }
          ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { x: { grid: { display: false }, stacked: true }, y: { beginAtZero: true, grid: { color: '#F1F5F9' }, stacked: true } } }
      });
    }

    function completeM2() {
      document.getElementById('nav-m2').classList.add('done');
      document.getElementById('nav-m2-circle').className = 'circle done';
      document.getElementById('nav-m2-circle').textContent = 'âœ“';
      document.getElementById('nav-m2-status').textContent = 'âœ“ å®Œæˆ';
      showPage('m3');
    }

    // Module 3: Optimization Steps
    function showOptStep(n) {
      document.querySelectorAll('.opt-step').forEach(s => s.style.display = 'none');
      document.getElementById('opt-step-' + n).style.display = 'block';
      for (let i = 1; i <= 4; i++) {
        const el = document.getElementById('st' + i);
        el.className = 'st-item' + (i === n ? ' active' : (i < n ? ' done' : ''));
      }
      // Sync global params to confirmation view when entering Step 3
      if (n === 3) {
        const maxC = document.getElementById('m3-max-contracts');
        const genS = document.getElementById('m3-gen-split');
        if (maxC) document.getElementById('m3-confirm-max-contracts').textContent = maxC.value;
        if (genS) document.getElementById('m3-confirm-gen-split').textContent = genS.value;
      }
    }

    function runGA() {
      document.getElementById('ga-idle').style.display = 'none';
      document.getElementById('ga-running').style.display = 'block';
      const bar = document.getElementById('ga-progress');
      const status = document.getElementById('ga-status');
      const msgs = ['åˆå§‹åŒ–æ—ç¾¤ (100 å€‹é«”)...', 'ç¬¬ 50 ä»£ - é©æ‡‰åº¦: 2.85M...', 'ç¬¬ 150 ä»£ - é©æ‡‰åº¦: 2.95M...', 'ç¬¬ 300 ä»£ - é©æ‡‰åº¦: 3.08M...', 'ç¬¬ 450 ä»£ - é©æ‡‰åº¦: 3.12M...', 'ç¬¬ 500 ä»£ - æ”¶æ–‚å®Œæˆï¼æœ€ä½³é©æ‡‰åº¦: 3.13M'];
      let step = 0;
      const interval = setInterval(() => {
        step++;
        const pct = Math.min(step * 18, 100);
        bar.style.width = pct + '%';
        if (step - 1 < msgs.length) status.textContent = msgs[step - 1];
        if (pct >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            document.getElementById('ga-running').style.display = 'none';
            document.getElementById('ga-done').style.display = 'block';
            document.getElementById('ga-chart-wrap').style.display = 'block';
            drawGAChart();
          }, 400);
        }
      }, 500);
    }

    function drawGAChart() {
      const ctx = document.getElementById('chartGA').getContext('2d');
      const gens = Array.from({ length: 50 }, (_, i) => (i + 1) * 10);
      const fitness = gens.map(g => 2800000 + 328500 * (1 - Math.exp(-g / 150)) + (Math.random() - 0.5) * 20000);
      if (window.gaChart) window.gaChart.destroy();
      window.gaChart = new Chart(ctx, {
        type: 'line',
        data: { labels: gens.map(g => 'Gen ' + g), datasets: [{ label: 'æœ€ä½³é©æ‡‰åº¦ (æ¯›åˆ©)', data: fitness, borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4, pointRadius: 1, borderWidth: 2 }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }, y: { beginAtZero: false, grid: { color: '#F1F5F9' }, ticks: { callback: v => '$' + Math.round(v / 1000) + 'K' } } } }
      });
    }

    // Module 3: Manual company entry
    let m3GenCounter = 5;
    let m3UsrCounter = 6;

    function toggleTaipowerExclude(exclude) {
      document.querySelectorAll('#m3-gen-list .check-item[data-taipower="true"]').forEach(label => {
        const cb = label.querySelector('input[type="checkbox"]');
        if (exclude) {
          cb.checked = false;
          cb.disabled = true;
          label.classList.remove('checked');
          label.style.opacity = '0.45';
          label.style.pointerEvents = 'none';
        } else {
          cb.disabled = false;
          label.style.opacity = '';
          label.style.pointerEvents = '';
        }
      });
    }

    function toggleM3AddForm(type) {
      const form = document.getElementById('m3-add-' + type + '-form');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function addM3Company(type) {
      if (type === 'gen') {
        const name = document.getElementById('m3-new-gen-name').value.trim();
        const genType = document.getElementById('m3-new-gen-type').value;
        const cap = document.getElementById('m3-new-gen-cap').value || '500';
        const price = document.getElementById('m3-new-gen-price').value || '4.00';
        if (!name) { alert('è«‹è¼¸å…¥æ¡ˆå ´åç¨±'); return; }
        const id = 'GEN-' + String(m3GenCounter++).padStart(3, '0');
        const emoji = genType.split(' ')[0];
        const list = document.getElementById('m3-gen-list');
        const lbl = document.createElement('label');
        lbl.className = 'check-item checked';
        lbl.innerHTML = '<input type="checkbox" checked onchange="toggleCheck(this)"> ' + emoji + ' ' + id + ' ' + name + ' ' + cap + 'kWï¼ˆæ”¶è³¼åƒ¹ ' + price + 'ï¼‰<span class="source-tag manual">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³</span>';
        list.appendChild(lbl);
        // Reset form
        document.getElementById('m3-new-gen-name').value = '';
        document.getElementById('m3-new-gen-cap').value = '';
        document.getElementById('m3-new-gen-price').value = '';
        document.getElementById('m3-add-gen-form').style.display = 'none';
      } else {
        const name = document.getElementById('m3-new-usr-name').value.trim();
        const price = document.getElementById('m3-new-usr-price').value || '5.00';
        if (!name) { alert('è«‹è¼¸å…¥ä¼æ¥­åç¨±'); return; }
        const id = 'USR-' + String(m3UsrCounter++).padStart(3, '0');
        const list = document.getElementById('m3-usr-list');
        const lbl = document.createElement('label');
        lbl.className = 'check-item checked';
        lbl.innerHTML = '<input type="checkbox" checked onchange="toggleCheck(this)"> ğŸ¢ ' + id + ' ' + name + 'ï¼ˆå”®é›»åƒ¹ ' + price + 'ï¼‰<span class="source-tag manual">ğŸ“¤ æ‰‹å‹•ä¸Šå‚³</span>';
        list.appendChild(lbl);
        // Reset form
        document.getElementById('m3-new-usr-name').value = '';
        document.getElementById('m3-new-usr-price').value = '';
        document.getElementById('m3-add-usr-form').style.display = 'none';
      }
    }

    // Checkbox toggle styling
    document.querySelectorAll('.check-item input[type=checkbox]').forEach(cb => {
      cb.addEventListener('change', () => cb.closest('.check-item').classList.toggle('checked', cb.checked));
    });
  </script>
</body>

</html>